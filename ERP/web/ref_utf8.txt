import React, { useState, useEffect } from 'react';
import styles from './PropertyCard.module.css';
import { User, Phone, MapPin, Building, DollarSign, FileText, Save, Trash2, Printer, Copy, Plus, Star, ChevronDown, ChevronUp, Search, X, Download } from 'lucide-react';
import PersonSelectorModal from './PersonSelectorModal';
import { useRouter } from 'next/navigation';
import { Map, MapMarker, MapTypeId, useKakaoLoader } from 'react-kakao-maps-sdk';
import PropertyReportTab from './PropertyReportTab';
import DaumPostcodeEmbed from 'react-daum-postcode';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, Line } from 'recharts';
import * as XLSX from 'xlsx';
import JSZip from 'jszip';
import { saveAs } from 'file-saver';

// ... (previous imports)
import { getSupabase } from '@/lib/supabase';

interface RevenueItem {
    id: string;
    date: string; // YYYY-MM
    cash: number;
    card: number;
    total: number;
    details?: string;
}

// ... (existing interfaces)
const INDUSTRY_DATA: Record<string, Record<string, string[]>> = {
    '?붿떇??: {
        '而ㅽ뵾': ['而ㅽ뵾?꾨Ц??, '?뚰삎而ㅽ뵾??, '以묓삎而ㅽ뵾??, '??뺤빱?쇱젏', '?뚯씠?ъ븘??, '?붿??몄뭅??],
        '?뚮즺': ['伊ъ뒪?꾨Ц??, '踰꾨툝??],
        '?꾩씠?ㅽ겕由쇰튃??: ['?꾩씠?ㅽ겕由?, '鍮숈닔?꾨Ц??],
        '遺꾩떇': ['源諛μ쟾臾몄젏', '遺꾩떇??, '?〓낭??],
        '移섑궓': ['移섑궓??],
        '?쇱옄': [],
        '?⑥뒪?명뫖??: ['?⑥뒪?명뫖??],
        '?쒓낵?쒕뭇': [],
        '?쒖떇': ['?쒖떇', '?쇰컲?앸떦', '二쎌쟾臾몄젏', '鍮꾨퉼諛?, '?꾩떆??, '怨좉린?꾨Ц??],
        '?쇱떇': ['?쇱떇', '?덇퉴??, '?곕룞', '?잛쭛', '李몄튂?꾨Ц??],
        '以묒떇': ['以묓솕?붾━'],
        '?쒖뼇??: ['?덉뒪?좊옉', '?ㅽ뙆寃뚰떚', '?뚯뒪?', '釉뚮윴移?],
        '湲고??멸뎅??: ['?援?닔', '?⑥쟾?뚯떇??],
        '二쇱젏': ['?쇰컲二쇱젏', '?뚯＜諛?, '移섑궓?명봽', '?댁옄源뚯빞', '留μ＜?꾨Ц??, '?ъ옣留덉감', '?⑥쟾二쇱젏', '??몃컮', 'bar', '?⑤?二쇱젏', '?좏씎二쇱젏', '?몃옒二쇱젏', '湲고?'],
        '湲고??몄떇': ['?몃뱶?몃윮', '湲고?']
    },
    '?쒕퉬?ㅼ뾽': {
        '?대???: ['誘몄슜??, '?ㅼ씪??, '?쇰?愿由?],
        '?좎븘': ['?ㅼ쫰移댄럹'],
        '?명긽': ['?명긽??],
        '?먮룞李?: ['二쇱감??, '?몄감??],
        '?ㅽ룷痢?: ['?ㅽ겕由곌낏??, '?밴뎄??, '?섑듃?덉뒪', '?レ슂媛', '?꾩뒪?ㅽ룷痢?],
        '?ㅻ씫': ['?몃옒諛?, 'dvd諛?, '硫?곕갑', '?곹솕愿'],
        'pc諛?: ['pc諛?],
        '?붿옣??: ['?붿옣??],
        '?섎쪟/?⑥뀡': ['?⑥뀡?≫솕', '?좊챸?섎쪟'],
        '諛섎젮?숇Ъ': ['?숇Ъ?⑺뭹'],
        '?덇꼍': ['?덇꼍??],
        '湲고??쒕퉬??: ['?ъ슦??, '湲고?'],
        '?댁넚': [],
        '?댁궗': [],
        '?몃젰?뚭껄': [],
        '諛곕떖': []
    },
    '?좏넻??: {
        '醫낇빀?뚮ℓ??: ['?먮ℓ??, '臾멸뎄??, '硫?곗꺏', '??뺣쭏??, '諛깊솕??, '??뺤눥?묐ぐ'],
        '?몄쓽??: ['?몄쓽??],
        '(嫄닿컯)?앺뭹': ['嫄닿컯?앺뭹'],
        '湲고??꾩냼留?: ['?앺솢?⑺뭹', '伊ъ뼹由?, '?꾨ℓ??, '?대???, '??뺢굔臾?, '湲고?'],
        '?띿닔?곕Ъ': []
    },
    '援먯쑁??: {
        '援먯쑁': ['?숈썝', '?낆꽌??]
    },
    '遺?숈궛??: {
        '?숇컯': ['?쒖뀡', '罹좏븨??, '怨좎떆??],
        '遺?숈궛以묎컻': ['紐⑤뜽?섏슦??],
        '?꾨?': ['怨듭떎']
    }
};

interface PropertyCardProps {
    property: any;
    onClose: () => void;
    onRefresh?: () => void;
}

interface PriceHistoryItem {
    id: string;
    date: string;
    manager: string;
    amount: number;
    isImportant: boolean;
    details: string;
}

interface WorkHistoryItem {
    id: string;
    date: string;
    manager: string;
    content: string;
    details: string;
    targetType: string;
    targetKeyword: string;
    targetId?: string; // LINKED: ID of the customer/businessCard
}

interface PropertyDocument {
    id: string;
    date: string;
    uploader: string;
    type: string; // pdf, xlsx, docx, etc.
    name: string;
    size: number;
    url?: string; // In a real app, this would be the S3/Cloud path
    path?: string; // Supabase Storage path
}



export default function PropertyCard({ property, onClose, onRefresh }: PropertyCardProps) {
    useKakaoLoader({
        appkey: "26c1197bae99e17f8c1f3e688e22914d",
        libraries: ["clusterer", "drawing", "services"],
    });
    const router = useRouter();
    const [formData, setFormData] = useState<any>(() => {
        // Safe default: If new property (no ID) and no manager set, try to default to current user
        if (!property.id && !property.managerId) {
            if (typeof window !== 'undefined') {
                try {
                    const userStr = localStorage.getItem('user');
                    if (userStr) {
                        const parsed = JSON.parse(userStr);
                        const user = parsed.user || parsed;
                        if (user.id) {
                            return {
                                ...property,
                                managerId: user.id || property.managerId,
                                managerName: user.name || property.managerName
                            };
                        }
                    }
                } catch (e) {
                    console.error('Failed to load user from storage', e);
                }
            }
        }
        return property;
    });

    const [activeTab, setActiveTab] = useState('priceWork');
    const [openSections, setOpenSections] = useState({

        overview: true,
        contact: true,
        price: true,
        revenue: true,
        franchise: true,
        operation: true,
        lease: true
    });

    const [isLoading, setIsLoading] = useState(false);
    const [managers, setManagers] = useState<any[]>([]);
    const [isMapOpen, setIsMapOpen] = useState(false);
    const [previewImage, setPreviewImage] = useState<string | null>(null);
    const [activeMapOverlay, setActiveMapOverlay] = useState<string | null>(null);
    const [mapConstants, setMapConstants] = useState<{ [key: string]: any } | null>(null);
    const [directReportPreview, setDirectReportPreview] = useState<number>(0);
    const [toast, setToast] = useState<{ message: string; visible: boolean }>({ message: '', visible: false });


    // Init Map Constants safely
    useEffect(() => {
        if (typeof window !== 'undefined' && window.kakao && window.kakao.maps) {
            setMapConstants({
                TERRAIN: window.kakao.maps.MapTypeId.TERRAIN,
                USE_DISTRICT: window.kakao.maps.MapTypeId.USE_DISTRICT,
                HYBRID: window.kakao.maps.MapTypeId.HYBRID
            });
        }
    }, [isLoading, isMapOpen, activeTab]); // Retry on state changes that might follow load


    // Auto-save logic
    const autoSaveProperty = async (data: any) => {
        if (data.id) {
            try {
                const res = await fetch(`/api/properties?id=${data.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (res.ok) {
                    onRefresh?.();
                } else {
                    console.error('Auto-save failed');
                }
            } catch (error) {
                console.error('Failed to auto-save:', error);
            }
        }
    };

    // Fix: Map UUID to Display ID for existing properties
    useEffect(() => {
        if (managers.length > 0 && formData.managerId) {
            // Find manager where UUID matches current formData.managerId
            const matchedByUuid = managers.find(m => m.uuid === formData.managerId);

            // If matched, meaning we have a UUID (from DB) but need a Display ID (for Dropdown)
            if (matchedByUuid && matchedByUuid.id !== formData.managerId) {
                setFormData((prev: any) => ({
                    ...prev,
                    managerId: matchedByUuid.id, // Switch to Display ID (e.g., "admin")
                    managerName: matchedByUuid.name
                }));
            }
        }
    }, [managers, formData.managerId]);


    // History Popup State
    const [isPriceHistoryOpen, setIsPriceHistoryOpen] = useState(false);
    const [isWorkHistoryOpen, setIsWorkHistoryOpen] = useState(false);
    const [editingHistoryId, setEditingHistoryId] = useState<string | null>(null);

    const [priceHistoryForm, setPriceHistoryForm] = useState({
        date: new Date().toISOString().split('T')[0],
        amount: 0,
        isImportant: false,
        details: ''
    });
    const [workHistoryForm, setWorkHistoryForm] = useState({
        date: new Date().toISOString().split('T')[0],
        content: '',
        details: '',
        targetType: 'customer',
        targetKeyword: '',
        targetId: '' // Initialize targetId
    });

    // Person Selector State
    const [isPersonSelectorOpen, setIsPersonSelectorOpen] = useState(false);
    const [personSelectorMode, setPersonSelectorMode] = useState<'workHistory' | 'promotedCustomer'>('workHistory');
    const [initialPersonTab, setInitialPersonTab] = useState<'customer' | 'businessCard'>('customer');

    // Contract History State
    const [isContractModalOpen, setIsContractModalOpen] = useState(false);
    const [editingContractId, setEditingContractId] = useState<string | null>(null);
    const [contractForm, setContractForm] = useState({
        type: '留ㅻℓ', // 留ㅻℓ, ?꾩꽭, ?붿꽭, ?곗꽭
        contractorName: '',
        contractorPhone: '',
        contractDate: new Date().toISOString().split('T')[0],
        expirationDate: '',
        deposit: 0,
        monthlyRent: 0,
        premium: 0,
        details: ''
    });




    const syncToPerson = async (personId: string, type: 'customer' | 'businessCard', propertyData: any) => {
        try {
            // 1. Fetch Person Data
            const endpoint = type === 'customer'
                ? `/api/customers?id=${personId}`
                : `/api/business-cards?id=${personId}`;

            const res = await fetch(endpoint);
            if (!res.ok) return;
            const personData = await res.json();

            let updatedPerson = { ...personData };
            let hasChanges = false;

            // 2. Add to Promoted Properties (if not exists)
            const currentPromoted = personData.promotedProperties || [];
            if (!currentPromoted.some((p: any) => p.id === propertyData.id)) {
                const newPromoted = {
                    id: propertyData.id,
                    name: propertyData.name,
                    status: propertyData.status,
                    type: propertyData.type || '',
                    dealType: propertyData.dealType || '',
                    price: propertyData.totalPrice || 0,
                    addedDate: new Date().toISOString().split('T')[0]
                };
                updatedPerson.promotedProperties = [...currentPromoted, newPromoted];
                hasChanges = true;
            }

            // 3. Add History
            const userStr = localStorage.getItem('user');
            let managerName = 'System';
            if (userStr) {
                const u = JSON.parse(userStr);
                managerName = (u.user || u).name || u.managerName || 'System';
            }

            const newHistory = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                date: new Date().toISOString().split('T')[0],
                manager: managerName,
                relatedProperty: propertyData.name,
                content: `異붿쭊臾쇨굔 ?깅줉: ${propertyData.name}`,
                details: '留ㅻЪ移대뱶?먯꽌 異붿쭊怨좉컼?쇰줈 ?깅줉?섏뼱 ?먮룞 ?곕룞??,
                type: 'auto'
            };

            updatedPerson.history = [newHistory, ...(updatedPerson.history || [])];
            hasChanges = true;

            // 4. Save
            if (hasChanges) {
                const updateUrl = type === 'customer' ? '/api/customers' : '/api/business-cards';
                await fetch(updateUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedPerson)
                });
            }
        } catch (e) {
            console.error('Failed to sync person:', e);
        }
    };

    const handlePersonSelect = async (person: any, type: 'customer' | 'businessCard') => {
        const name = person.name || person.company || '';
        const phone = person.phone || '';
        const feature = person.feature || person.memo || '';

        if (personSelectorMode === 'workHistory') {
            setWorkHistoryForm(prev => ({
                ...prev,
                targetType: type,
                content: `${name} ${phone ? `(${phone})` : ''}`,
                details: feature,
                targetKeyword: name,
                targetId: person.id // STORE ID
            }));
        } else {
            // Promoted Customer Mode
            const newCustomer = {
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                name: name,
                type: type, // 'customer' or 'businessCard'
                classification: person.grade || person.category || '-', // 遺꾨쪟
                budget: person.budget || '-', // ?덉궛
                features: feature,
                targetId: person.id,
                contact: phone
            };

            const currentList = formData.promotedCustomers || [];

            // Check Duplicate
            if (currentList.some((c: any) => c.targetId === person.id)) {
                alert('?대? ?깅줉??怨좉컼?낅땲??');
                return;
            }

            const updatedFormData = {
                ...formData,
                promotedCustomers: [...currentList, newCustomer]
            };
            setFormData(updatedFormData);
            autoSaveProperty(updatedFormData);

            // Sync to Schedule
            await addScheduleEvent(
                `[異붿쭊?깅줉] ${name} - ${property.name}`,
                newCustomer.date,
                'work',
                '#339af0',
                property.id,
                `異붿쭊怨좉컼 ?깅줉: ${name} (${phone})`
            );

            // NEW: Sync promoted property to Person (Customer/BusinessCard) without adding work history
            await syncPromotedProperty(person.id, type, formData);
        }
        setIsPersonSelectorOpen(false);
    };

    const handleAddContract = () => {
        setEditingContractId(null);
        setContractForm({
            type: '留ㅻℓ',
            contractorName: '',
            contractorPhone: '',
            contractDate: new Date().toISOString().split('T')[0],
            expirationDate: '',
            deposit: 0,
            monthlyRent: 0,
            premium: 0,
            details: ''
        });
        setIsContractModalOpen(true);
    };

    const handleEditContract = (contract: any) => {
        setEditingContractId(contract.id);
        setContractForm({
            type: contract.type || '留ㅻℓ',
            contractorName: contract.contractorName || '',
            contractorPhone: contract.contractorPhone || '',
            contractDate: contract.contractDate || '',
            expirationDate: contract.expirationDate || '',
            deposit: contract.deposit || 0,
            monthlyRent: contract.monthlyRent || 0,
            premium: contract.premium || 0,
            details: contract.details || ''
        });
        setIsContractModalOpen(true);
    };

    const handleSaveContract = async () => {
        const newContract = {
            id: editingContractId || Date.now().toString(),
            ...contractForm
        };

        const currentList = formData.contractHistory || [];
        let updatedList;

        if (editingContractId) {
            updatedList = currentList.map((c: any) => c.id === editingContractId ? newContract : c);
        } else {
            updatedList = [...currentList, newContract];
        }

        const updatedFormData = { ...formData, contractHistory: updatedList };
        setFormData(updatedFormData);
        setIsContractModalOpen(false);
        autoSaveProperty(updatedFormData);

        // Sync to Schedule (Only for new contracts)
        if (!editingContractId) {
            await addScheduleEvent(
                `[怨꾩빟] ${contractForm.contractorName} - ${property.name}`,
                contractForm.contractDate,
                'contract',
                '#ff6b6b',
                property.id,
                `怨꾩빟 ?깅줉: ${contractForm.type} / 蹂댁쬆湲?${contractForm.deposit} / ?붿꽭 ${contractForm.monthlyRent}`
            );
        }
    };

    const handleDeleteContract = async () => {
        if (!editingContractId) return;
        if (!confirm('?뺣쭚 ??젣?섏떆寃좎뒿?덇퉴?')) return;

        const updatedList = formData.contractHistory.filter((c: any) => c.id !== editingContractId);
        const updatedFormData = { ...formData, contractHistory: updatedList };
        setFormData(updatedFormData);
        setIsContractModalOpen(false);
        autoSaveProperty(updatedFormData);
    };

    const handleRemovePromotedCustomer = async (index: number) => {
        if (!confirm('紐⑸줉?먯꽌 ?쒓굅?섏떆寃좎뒿?덇퉴?')) return;

        // Get the item to be removed to sync deletion
        const itemToRemove = formData.promotedCustomers[index];

        const updatedList = formData.promotedCustomers.filter((_: any, i: number) => i !== index);
        const updatedFormData = { ...formData, promotedCustomers: updatedList };
        setFormData(updatedFormData);
        autoSaveProperty(updatedFormData);

        // Sync Deletion
        if (itemToRemove && itemToRemove.targetId) {
            await deletePromotedPropertyFromPerson(itemToRemove.targetId, itemToRemove.type || 'customer', formData.id);
        }
    };

    // Global ESC Handler for Sequential Closing


    // Date Formatter
    const formatDate = (date: Date | string) => {
        if (!date) return '';
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // Date Helper for Popups
    const adjustDate = (days: number, type: 'price' | 'work') => {
        const targetForm = type === 'price' ? priceHistoryForm : workHistoryForm;
        const setTargetForm = type === 'price' ? setPriceHistoryForm : setWorkHistoryForm;

        const currentDate = new Date(targetForm.date);
        currentDate.setDate(currentDate.getDate() + days);
        const newDate = currentDate.toISOString().split('T')[0];

        setTargetForm((prev: any) => ({ ...prev, date: newDate }));
    };

    const setDateTo = (target: 'today' | 'yesterday' | 'tomorrow', type: 'price' | 'work') => {
        const setTargetForm = type === 'price' ? setPriceHistoryForm : setWorkHistoryForm;
        const date = new Date();
        if (target === 'yesterday') date.setDate(date.getDate() - 1);
        if (target === 'tomorrow') date.setDate(date.getDate() + 1);

        setTargetForm((prev: any) => ({ ...prev, date: date.toISOString().split('T')[0] }));
    };

    const handleDeletePriceHistory = async () => {
        if (!editingHistoryId) return;
        if (!confirm('?뺣쭚 ??젣?섏떆寃좎뒿?덇퉴?')) return;

        const updatedPriceHistory = formData.priceHistory.filter((item: any) => item.id !== editingHistoryId);
        const updatedFormData = { ...formData, priceHistory: updatedPriceHistory };

        setFormData(updatedFormData);
        setIsPriceHistoryOpen(false);

        // Auto-save
        if (formData.id) {
            try {
                const res = await fetch(`/api/properties?id=${formData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedFormData),
                });
                if (res.ok) {
                    onRefresh?.();
                } else {
                    alert('?먮룞 ??μ뿉 ?ㅽ뙣?덉뒿?덈떎.');
                }
            } catch (error) {
                console.error('Failed to auto-save history:', error);
                alert('?먮룞 ???以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
            }
        } else {
            alert('?좉퇋 ?깅줉 以묒씤 臾쇨굔?낅땲?? ?꾩껜 ??μ쓣 ?뚮윭??諛섏쁺?⑸땲??');
        }
    };

    const handleAddPriceHistory = () => {
        setEditingHistoryId(null);
        // Validation for numeric fields
        const ensureNumber = (val: any) => {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            return Number(String(val).replace(/,/g, ''));
        };

        const total = ensureNumber(formData.deposit) + ensureNumber(formData.premium) + ensureNumber(formData.briefingPrice);

        setPriceHistoryForm({
            date: new Date().toISOString().split('T')[0],
            amount: total,
            isImportant: false,
            details: ''
        });
        setIsPriceHistoryOpen(true);
    };

    const handleEditPriceHistory = (item: any) => {
        setEditingHistoryId(item.id);
        setPriceHistoryForm({
            date: item.date,
            amount: item.amount,
            isImportant: item.isImportant,
            details: item.details
        });
        setIsPriceHistoryOpen(true);
    };

    const handleSavePriceHistory = async () => {
        const newItem: PriceHistoryItem = {
            id: editingHistoryId || Date.now().toString(),
            date: priceHistoryForm.date,
            manager: formData.managerName || 'Unknown',
            amount: priceHistoryForm.amount,
            isImportant: priceHistoryForm.isImportant,
            details: priceHistoryForm.details
        };

        let updatedFormData;
        const currentList = formData.priceHistory || [];

        if (editingHistoryId) {
            updatedFormData = {
                ...formData,
                priceHistory: currentList.map((item: any) => item.id === editingHistoryId ? newItem : item)
            };
        } else {
            updatedFormData = {
                ...formData,
                priceHistory: [...currentList, newItem]
            };
        }

        // Sync to Premium (Request 2)
        // New Premium = New Total - (Deposit + Briefing)
        const currentDeposit = Number(formData.deposit) || 0;
        const currentBriefing = Number(formData.briefingPrice) || 0;
        const newTotal = Number(priceHistoryForm.amount) || 0;
        const newPremium = newTotal - (currentDeposit + currentBriefing);

        updatedFormData.premium = newPremium;
        updatedFormData.totalPrice = newTotal;

        // Recalculate Yield
        const monthlyProfit = updatedFormData.monthlyProfit || 0;
        const investment = (updatedFormData.deposit || 0) + (updatedFormData.premium || 0);
        updatedFormData.yieldPercent = investment > 0 ? (monthlyProfit / investment) * 100 : 0;

        setFormData(updatedFormData);
        setIsPriceHistoryOpen(false);

        // Add to Schedule (Request 4) - Only for new items
        if (!editingHistoryId) {
            // const statusLabel = statusMap[formData.status] || formData.status || '?곹깭誘몄젙';
            const scheduleTitle = `[湲덉븸蹂?? [${formData.name}] 쨌 (${formatCurrency(newTotal)} 留뚯썝)`;
            // Color: Orange (#fd7e14) for Price Change
            await addScheduleEvent(scheduleTitle, priceHistoryForm.date, 'price_change', '#fd7e14', formData.id);
        }

        // Auto-save
        if (formData.id) {
            try {
                const res = await fetch(`/api/properties?id=${formData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedFormData),
                });
                if (res.ok) {
                    onRefresh?.();
                } else {
                    alert('?먮룞 ??μ뿉 ?ㅽ뙣?덉뒿?덈떎.');
                }
            } catch (error) {
                console.error('Failed to auto-save history:', error);
                alert('?먮룞 ???以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
            }
        } else {
            alert('?좉퇋 ?깅줉 以묒씤 臾쇨굔?낅땲?? ?꾩껜 ??μ쓣 ?뚮윭??諛섏쁺?⑸땲??');
        }
    };

    const handleAddWorkHistory = () => {
        setEditingHistoryId(null);
        setWorkHistoryForm({
            date: new Date().toISOString().split('T')[0],
            content: '',
            details: '',
            targetType: 'customer',
            targetKeyword: '',
            targetId: ''
        });
        setIsWorkHistoryOpen(true);
    };

    const handleEditWorkHistory = (item: any) => {
        setEditingHistoryId(item.id);
        setWorkHistoryForm({
            date: item.date,
            content: item.content,
            details: item.details,
            targetType: item.targetType,
            targetKeyword: item.targetKeyword,
            targetId: item.targetId || ''
        });
        setIsWorkHistoryOpen(true);
    };

    const handleDeleteWorkHistory = async () => {
        if (!editingHistoryId) return;
        if (!confirm('?뺣쭚 ??젣?섏떆寃좎뒿?덇퉴?')) return;

        const updatedWorkHistory = formData.workHistory.filter((item: any) => item.id !== editingHistoryId);
        const updatedFormData = { ...formData, workHistory: updatedWorkHistory };

        setFormData(updatedFormData);
        setIsWorkHistoryOpen(false);

        // Auto-save
        if (formData.id) {
            try {
                const res = await fetch(`/api/properties?id=${formData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedFormData),
                });
                if (res.ok) {
                    onRefresh?.();
                    // Sync Delete to Person
                    const deletedItem = formData.workHistory.find((item: any) => item.id === editingHistoryId);
                    if (deletedItem && deletedItem.targetId) {
                        deleteWorkHistoryFromPerson(deletedItem.targetId, deletedItem.targetType || 'customer', deletedItem);
                    }
                } else {
                    alert('?먮룞 ??μ뿉 ?ㅽ뙣?덉뒿?덈떎.');
                }
            } catch (error) {
                console.error('Failed to auto-save history:', error);
                alert('?먮룞 ???以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
            }
        } else {
            alert('?좉퇋 ?깅줉 以묒씤 臾쇨굔?낅땲?? ?꾩껜 ??μ쓣 ?뚮윭??諛섏쁺?⑸땲??');
        }
    };

    const deleteWorkHistoryFromPerson = async (personId: string, type: string, historyItem: any) => {
        try {
            const endpoint = type === 'customer'
                ? `/api/customers?id=${personId}`
                : `/api/business-cards?id=${personId}`;

            const res = await fetch(endpoint);
            if (!res.ok) return;
            const personData = await res.json();

            const updatedHistory = (personData.history || []).filter((h: any) => {
                let isMatch = false;
                // 1. Strict ID Match
                if (h.targetId && formData.id) {
                    isMatch = h.targetId === formData.id &&
                        h.date === historyItem.date &&
                        h.content === historyItem.content;
                }
                // 2. Fallback Match (Only if targetId is missing in history item)
                if (!isMatch && !h.targetId) {
                    isMatch = h.relatedProperty === formData.name &&
                        h.date === historyItem.date &&
                        h.content === historyItem.content;
                }
                return !isMatch;
            });

            if (updatedHistory.length === (personData.history || []).length) return;

            const updatedPerson = {
                ...personData,
                history: updatedHistory
            };

            const updateUrl = type === 'customer' ? '/api/customers' : '/api/business-cards';
            await fetch(updateUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedPerson)
            });
        } catch (e) {
            console.error('Failed to sync delete to person:', e);
        }
    };

    const deletePromotedPropertyFromPerson = async (personId: string, type: string, propertyId: string) => {
        try {
            const endpoint = type === 'customer'
                ? `/api/customers?id=${personId}`
                : `/api/business-cards?id=${personId}`;

            const res = await fetch(endpoint);
            if (!res.ok) return;
            const personData = await res.json();

            // Filter out the promoted property
            const updatedPromoted = (personData.promotedProperties || []).filter((p: any) => p.id !== propertyId);

            if (updatedPromoted.length === (personData.promotedProperties || []).length) return;

            const updatedPerson = {
                ...personData,
                promotedProperties: updatedPromoted
            };

            const updateUrl = type === 'customer' ? '/api/customers' : '/api/business-cards';
            await fetch(updateUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedPerson)
            });
        } catch (e) {
            console.error('Failed to sync promoted property deletion to person:', e);
        }
    };

    const syncWorkHistoryToPerson = async (personId: string, type: string, historyItem: WorkHistoryItem, propertyName: string) => {
        try {
            const endpoint = type === 'customer'
                ? `/api/customers?id=${personId}`
                : `/api/business-cards?id=${personId}`;

            const res = await fetch(endpoint);
            if (!res.ok) {
                console.error(`Sync Error: Failed to fetch person data (Status: ${res.status})`);
                return;
            }
            const personData = await res.json();

            // Create History Item for Person
            const newHistory = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                date: historyItem.date,
                manager: historyItem.manager,
                relatedProperty: propertyName, // LINKED PROPERTY NAME
                content: historyItem.content,
                details: historyItem.details || '',
                type: 'auto',
                targetId: formData.id // Link back to Property ID
            };

            const updatedPerson = {
                ...personData,
                history: [newHistory, ...(personData.history || [])]
            };

            const updateUrl = type === 'customer' ? '/api/customers' : '/api/business-cards';
            const putRes = await fetch(updateUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedPerson)
            });

            if (putRes.ok) {
                // Success silently
            } else {
                console.error(`Sync Error: Person Update Failed (Status: ${putRes.status})`);
            }

        } catch (e) {
            console.error('Failed to sync work history to person:', e);
            alert(`Sync Failed: ${e}`);
        }
    };



    // New function: sync promoted property to person without adding work history
    const syncPromotedProperty = async (personId: string, type: 'customer' | 'businessCard', propertyData: any) => {
        try {
            const endpoint = type === 'customer'
                ? `/api/customers?id=${personId}`
                : `/api/business-cards?id=${personId}`;
            const res = await fetch(endpoint);
            if (!res.ok) {
                console.error(`Sync Error: Failed to fetch person data (Status: ${res.status})`);
                return;
            }
            const personData = await res.json();
            const currentPromoted = personData.promotedProperties || [];
            const exists = currentPromoted.some((p: any) => p.id === propertyData.id);
            if (!exists) {
                const newPromoted = {
                    id: propertyData.id,
                    name: propertyData.name,
                    status: propertyData.status,
                    type: propertyData.type || '',
                    dealType: propertyData.dealType || '',
                    price: propertyData.totalPrice || 0,
                    addedDate: new Date().toISOString().split('T')[0]
                };
                const updatedPerson = {
                    ...personData,
                    promotedProperties: [...currentPromoted, newPromoted]
                };
                const updateUrl = type === 'customer' ? '/api/customers' : '/api/business-cards';
                await fetch(updateUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedPerson)
                });
            }
        } catch (e) {
            console.error('Failed to sync promoted property to person:', e);
        }
    };

    const handleSaveWorkHistory = async () => {
        if (!workHistoryForm.content) {
            alert('?댁뿭???낅젰?댁＜?몄슂.');
            return;
        }

        const newItem: WorkHistoryItem = {
            id: editingHistoryId || Date.now().toString(),
            date: workHistoryForm.date,
            manager: formData.managerName || 'Unknown',
            content: workHistoryForm.content,
            details: workHistoryForm.details,
            targetType: workHistoryForm.targetType,
            targetKeyword: workHistoryForm.targetKeyword,
            targetId: (workHistoryForm as any).targetId // Access generic prop
        };

        // DEBUG - removed


        let updatedFormData;
        const currentList = formData.workHistory || [];

        if (editingHistoryId) {
            updatedFormData = {
                ...formData,
                workHistory: currentList.map((item: any) => item.id === editingHistoryId ? newItem : item)
            };
        } else {
            updatedFormData = {
                ...formData,
                workHistory: [...currentList, newItem]
            };
        }

        setFormData(updatedFormData);
        setIsWorkHistoryOpen(false);
        setEditingHistoryId(null);

        // Auto-save
        if (formData.id) {
            try {
                const res = await fetch(`/api/properties?id=${formData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedFormData),
                });
                if (res.ok) {
                    onRefresh?.();

                    // Single Schedule Event Creation
                    // Only for NEW items (editingHistoryId is null)
                    if (!editingHistoryId) {
                        const targetId = (workHistoryForm as any).targetId;
                        const targetType = workHistoryForm.targetType;

                        let scheduleTitle = `[?묒뾽] [${formData.name}] 쨌 ${workHistoryForm.content}`;
                        let additionalProps: any = {};
                        let eventColor = '#20c997'; // Default Teal for generic work

                        if (targetId) {
                            // If linked to a person, customize the title and props
                            if (targetType === 'customer') {
                                scheduleTitle = `[怨좉컼?묒뾽] ${workHistoryForm.targetKeyword || 'Unknown'} - [${formData.name}] 쨌 ${workHistoryForm.content}`;
                                additionalProps.customerId = targetId;
                            } else if (targetType === 'businessCard') {
                                scheduleTitle = `[紐낇븿?묒뾽] ${workHistoryForm.targetKeyword || 'Unknown'} - [${formData.name}] 쨌 ${workHistoryForm.content}`;
                                additionalProps.businessCardId = targetId;
                            }
                        }

                        await addScheduleEvent(
                            scheduleTitle,
                            workHistoryForm.date,
                            'work',
                            eventColor,
                            formData.id,
                            undefined, // No specific scheduleId needed
                            additionalProps
                        );
                    }

                    // Sync to Person if targetId exists
                    if ((workHistoryForm as any).targetId) {
                        await syncWorkHistoryToPerson(
                            (workHistoryForm as any).targetId,
                            workHistoryForm.targetType,
                            newItem,
                            formData.name
                        );
                    }
                } else {
                    alert('?먮룞 ??μ뿉 ?ㅽ뙣?덉뒿?덈떎.');
                }
            } catch (error) {
                console.error('Failed to auto-save history:', error);
                alert('?먮룞 ???以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
            }
        } else {
            alert('?좉퇋 ?깅줉 以묒씤 臾쇨굔?낅땲?? ?꾩껜 ??μ쓣 ?뚮윭??諛섏쁺?⑸땲??');
        }
    };

    // Address Search State
    const [isSearchOpen, setIsSearchOpen] = useState(false);

    // Area Unit State
    const [areaUnit, setAreaUnit] = useState<'pyeong' | 'm2'>('pyeong');
    const PYEONG_TO_M2 = 3.305785;

    const handleAreaChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const val = e.target.value;
        // Allow empty string for clearing input
        if (val === '') {
            setFormData((prev: any) => ({ ...prev, area: '' }));
            return;
        }

        const numVal = Number(val);
        if (isNaN(numVal)) return;

        if (areaUnit === 'pyeong') {
            // Direct update (assuming stored in Pyeong)
            setFormData((prev: any) => ({ ...prev, area: numVal }));
        } else {
            // Convert m2 input to Pyeong for storage
            // m2 = py * 3.3... -> py = m2 / 3.3...
            const pyeongVal = numVal / PYEONG_TO_M2;
            setFormData((prev: any) => ({ ...prev, area: pyeongVal }));
        }
    };

    const getDisplayArea = () => {
        const val = Number(formData.area);
        if (!val && val !== 0) return '';

        if (areaUnit === 'pyeong') {
            // If stored as Pyeong, ensure we limit decimals for display if needed, 
            // but usually raw input is fine unless it's result of calculation
            // Let's allow up to 2 decimal places for cleanliness if it's a long float
            return Math.round(val * 100) / 100;
        } else {
            // Convert to m2
            return (val * PYEONG_TO_M2).toFixed(2);
        }
    };

    // Brand Search State
    const [isBrandSearchOpen, setIsBrandSearchOpen] = useState(false);
    const [brandSearchQuery, setBrandSearchQuery] = useState('');
    const [brandSearchResults, setBrandSearchResults] = useState<any[]>([]);
    const [isSearchingBrand, setIsSearchingBrand] = useState(false);

    // Initial Empty Data for "New" mode
    const initialEmptyData = {
        name: '',
        status: '吏꾪뻾', // Default status
        managerId: '',
        managerName: '',
        address: '',
        addressDetail: '',
        buildingName: '',
        coordinates: { lat: 33.450701, lng: 126.570667 },
        isFavorite: false,
        area: '',
        floors: '',
        floorRange: '',
        deposit: 0,
        monthlyRent: 0,
        maintenance: 0,
        rentMaintenance: 0,
        premium: 0,
        totalPrice: 0,
        monthlyRevenue: 0,
        materialCost: 0,
        laborCost: 0,
        taxUtilities: 0,
        maintenanceDepreciation: 0,
        promoMisc: 0,
        totalExpense: 0,
        monthlyProfit: 0,
        yieldPercent: 0,
        locationMemo: '',
        featureMemo: '',
        contactMemo: '',
        memo: '',

        franchiseBrand: '',
        hqDeposit: 0,
        franchiseFee: 0,
        educationFee: 0,
        renewal: 0,
        royalty: 0,
        operationCustomFields: [],
        leaseCustomFields: []
    };

    // Custom Category State
    const [newOperationCategory, setNewOperationCategory] = useState('');
    const [newLeaseCategory, setNewLeaseCategory] = useState('');
    const [isAddingOperationCategory, setIsAddingOperationCategory] = useState(false);
    const [isAddingLeaseCategory, setIsAddingLeaseCategory] = useState(false);

    // Revenue State
    const [isRevenueModalOpen, setIsRevenueModalOpen] = useState(false);
    const [revenueForm, setRevenueForm] = useState({
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        cash: 0,
        card: 0
    });
    const [selectedRevenueIds, setSelectedRevenueIds] = useState<string[]>([]);
    const [editingRevenueId, setEditingRevenueId] = useState<string | null>(null);
    const fileInputRef = React.useRef<HTMLInputElement>(null);
    const photoInputRef = React.useRef<HTMLInputElement>(null);

    // Photo Handlers
    const handlePhotoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files.length > 0) {
            const files = Array.from(e.target.files);

            // Check Size Limit (5MB)
            const validFiles = files.filter(file => {
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    alert(`?뚯씪 ?⑸웾???덈Т ?쎈땲??(5MB ?쒗븳): ${file.name}`);
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) return;

            const readers = validFiles.map(file => {
                return new Promise<string>((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        if (typeof reader.result === 'string') resolve(reader.result);
                        else reject('Failed to read file');
                    };
                    reader.readAsDataURL(file);
                });
            });

            Promise.all(readers).then(results => {
                const updatedPhotos = [...(formData.photos || []), ...results];
                const updatedFormData = { ...formData, photos: updatedPhotos };

                setFormData(updatedFormData);
                if (photoInputRef.current) photoInputRef.current.value = '';

                // Auto Save
                autoSaveProperty(updatedFormData);
            });
        }
    };

    const handleDeletePhoto = (index: number) => {
        if (!window.confirm('?ъ쭊????젣?섏떆寃좎뒿?덇퉴?')) return;

        const updatedPhotos = formData.photos.filter((_: any, i: number) => i !== index);
        const updatedFormData = { ...formData, photos: updatedPhotos };

        setFormData(updatedFormData);
        // Auto Save
        autoSaveProperty(updatedFormData);
    };

    const handleDeleteAllPhotos = () => {
        if (!window.confirm('紐⑤뱺 ?ъ쭊????젣?섏떆寃좎뒿?덇퉴?')) return;

        const updatedFormData = { ...formData, photos: [] };
        setFormData(updatedFormData);
        // Auto Save
        autoSaveProperty(updatedFormData);
    };

    const handleDownloadPhoto = (photoUrl: string, index: number) => {
        const link = document.createElement('a');
        link.href = photoUrl;
        link.download = `property-photo-${index + 1}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        document.body.removeChild(link);
    };

    const handleDownloadAllPhotos = async () => {
        if (!formData.photos || formData.photos.length === 0) {
            alert('?ㅼ슫濡쒕뱶???ъ쭊???놁뒿?덈떎.');
            return;
        }

        const zip = new JSZip();
        formData.photos.forEach((photo: string, index: number) => {
            // Check if photo is base64
            if (photo.startsWith('data:image')) {
                const base64Data = photo.split(',')[1];
                zip.file(`property-photo-${index + 1}.png`, base64Data, { base64: true });
            }
        });

        try {
            const content = await zip.generateAsync({ type: 'blob' });
            saveAs(content, `property-${formData.name || 'photos'}.zip`);
        } catch (error) {
            console.error('Failed to zip photos:', error);
            alert('?ъ쭊 ?ㅼ슫濡쒕뱶 以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        }
    };

    // Revenue Handlers
    // Revenue Handlers
    const handleAddRevenue = () => {
        setEditingRevenueId(null);
        setRevenueForm({
            year: new Date().getFullYear(),
            month: new Date().getMonth() + 1,
            cash: 0,
            card: 0
        });
        setIsRevenueModalOpen(true);
    };

    const handleEditRevenue = (item: any) => {
        setEditingRevenueId(item.id);
        const [year, month] = item.date.split('-');
        setRevenueForm({
            year: Number(year),
            month: Number(month),
            cash: item.cash,
            card: item.card
        });
        setIsRevenueModalOpen(true);
    };

    const handleSaveRevenue = async () => {
        const dateStr = `${revenueForm.year}-${String(revenueForm.month).padStart(2, '0')}`;
        const currentHistory = formData.revenueHistory || [];

        // Check duplicate (exclude current editing item)
        const exists = currentHistory.find((item: any) => item.date === dateStr && item.id !== editingRevenueId);
        if (exists) {
            if (!confirm(`${dateStr} 留ㅼ텧 ?곗씠?곌? ?대? 議댁옱?⑸땲?? ??뼱?뚯슦?쒓쿋?듬땲源?`)) return;
        }

        const cash = Number(revenueForm.cash) || 0;
        const card = Number(revenueForm.card) || 0;
        const total = cash + card;

        let newHistory;

        if (editingRevenueId) {
            // Edit existing
            newHistory = currentHistory.map((item: any) =>
                item.id === editingRevenueId ? { ...item, date: dateStr, cash, card, total } : item
            );
            // If we overwrote another date by changing date, remove the old one? 
            // The duplicate check above asked to overwrite. 
            // If "exists", we should actually merge/replace the *other* one, or just update *this* one?
            // Simple logic: If confirmed overwrite, we filter out the `exists` item (if it's different ID) and update `editingRevenueId`.
            if (exists) {
                newHistory = newHistory.filter((item: any) => item.id !== exists.id);
            }
        } else {
            // Add New
            const newItem: RevenueItem = {
                id: exists ? exists.id : Date.now().toString(), // If exists confirmed, reuse ID or overwrite? Let's just create/overwrite.
                date: dateStr,
                cash,
                card,
                total
            };

            if (exists) {
                newHistory = currentHistory.map((item: any) => item.date === dateStr ? newItem : item);
            } else {
                newHistory = [...currentHistory, newItem];
            }
        }

        // Sort by date desc
        newHistory.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());

        const updatedFormData = { ...formData, revenueHistory: newHistory };
        setFormData(updatedFormData);
        setIsRevenueModalOpen(false);
        setEditingRevenueId(null);

        // Auto-save logic reuse
        await autoSaveProperty(updatedFormData);
    };

    const handleDeleteRevenue = async () => {
        if (selectedRevenueIds.length === 0) {
            alert('??젣????ぉ???좏깮?댁＜?몄슂.');
            return;
        }
        if (!confirm(`${selectedRevenueIds.length}嫄댁쓽 留ㅼ텧 ?댁뿭????젣?섏떆寃좎뒿?덇퉴?`)) return;

        const newHistory = (formData.revenueHistory || []).filter((item: any) => !selectedRevenueIds.includes(item.id));
        const updatedFormData = { ...formData, revenueHistory: newHistory };
        setFormData(updatedFormData);
        setSelectedRevenueIds([]);

        await autoSaveProperty(updatedFormData);
    };

    const handleDownloadTemplate = () => {
        const wb = XLSX.utils.book_new();
        const ws_data = [
            ['??, '??, '?꾧툑留ㅼ텧', '移대뱶留ㅼ텧'],
            ['2024', '1', '1000', '2000'],
            ['2024', '2', '1500', '2500']
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "留ㅼ텧?묒떇");
        XLSX.writeFile(wb, "?붾퀎留ㅼ텧?깅줉?묒떇.xlsx");
    };

    const handleExcelUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
            const bstr = evt.target?.result;
            const wb = XLSX.read(bstr, { type: 'binary' });
            const wsname = wb.SheetNames[0];
            const ws = wb.Sheets[wsname];
            const data = XLSX.utils.sheet_to_json(ws);

            const newItems: RevenueItem[] = [];
            data.forEach((row: any) => {
                const year = row['??] || row['Year'];
                const month = row['??] || row['Month'];
                const cash = Number(row['?꾧툑留ㅼ텧']) || 0;
                const card = Number(row['移대뱶留ㅼ텧']) || 0;

                if (year && month) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}`;
                    newItems.push({
                        id: Date.now().toString() + Math.random().toString(),
                        date: dateStr,
                        cash,
                        card,
                        total: cash + card
                    });
                }
            });

            if (newItems.length > 0) {
                // Merge logic (overwrite existing dates)
                const currentHistory = formData.revenueHistory || [];
                const mergedHistory = [...currentHistory];

                newItems.forEach(newItem => {
                    const idx = mergedHistory.findIndex((item: any) => item.date === newItem.date);
                    if (idx >= 0) {
                        mergedHistory[idx] = newItem;
                    } else {
                        mergedHistory.push(newItem);
                    }
                });

                mergedHistory.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());

                const updated = { ...formData, revenueHistory: mergedHistory };
                setFormData(updated);
                autoSaveProperty(updated);
                alert(`${newItems.length}嫄댁쓽 留ㅼ텧 ?곗씠?곌? ?깅줉?섏뿀?듬땲??`);
            }
        };
        reader.readAsBinaryString(file);
    };



    // Manager State (existing)

    useEffect(() => {
        setFormData(property);
    }, [property]);

    // Fetch Managers
    useEffect(() => {
        const loadManagers = async () => {
            try {
                const userStr = localStorage.getItem('user');
                if (userStr) {
                    const user = JSON.parse(userStr);
                    const currentUser = user.user || user; // Handle wrapped 'user' object

                    if (currentUser.companyName) {
                        const res = await fetch(`/api/users?company=${encodeURIComponent(currentUser.companyName)}`);
                        if (res.ok) {
                            const data = await res.json();
                            setManagers(data);
                        }
                    } else {
                        setManagers([currentUser]);
                    }

                    // Default to current user if new property and no manager set
                    if (!property.id && !formData.managerId) {
                        setFormData((prev: any) => ({
                            ...prev,
                            managerId: currentUser.id,
                            managerName: currentUser.name
                        }));
                    }
                }
            } catch (error) {
                console.error('Failed to load managers:', error);
            }
        };
        loadManagers();
    }, []);

    // Handle ESC key to close
    useEffect(() => {
        // Only attach if Person Selector is NOT open
        if (isPersonSelectorOpen) return;

        const handleEsc = (e: KeyboardEvent) => {
            if (e.key === 'Escape') {
                // Priority 1: Top-level overlays
                if (previewImage) {
                    setPreviewImage(null);
                    return;
                }
                if (isMapOpen) {
                    setIsMapOpen(false);
                    return;
                }
                if (isSearchOpen) {
                    setIsSearchOpen(false);
                    return;
                }
                if (isBrandSearchOpen) {
                    setIsBrandSearchOpen(false);
                    return;
                }

                // Priority 2: Content Modals
                if (isWorkHistoryOpen) {
                    setIsWorkHistoryOpen(false);
                    return;
                }
                if (isPriceHistoryOpen) {
                    setIsPriceHistoryOpen(false);
                    return;
                }
                if (isRevenueModalOpen) {
                    setIsRevenueModalOpen(false);
                    return;
                }

                // Priority 3: Close Property Card itself
                onClose();
            }
        };
        window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
    }, [
        isPersonSelectorOpen,
        previewImage,
        isMapOpen,
        isSearchOpen,
        isBrandSearchOpen,
        isWorkHistoryOpen,
        isPriceHistoryOpen,
        isRevenueModalOpen,
        onClose
    ]);


    if (!formData) return null;

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
        const { name, value } = e.target;
        setFormData((prev: any) => ({ ...prev, [name]: value }));
    };

    // Handle Manager Change
    const handleManagerChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const selectedId = e.target.value;
        const selectedManager = managers.find(m => m.id === selectedId);
        setFormData((prev: any) => ({
            ...prev,
            managerId: selectedId,
            managerName: selectedManager ? selectedManager.name : ''
        }));
    };

    const handlePriceChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        const rawValue = value.replace(/,/g, '');
        if (isNaN(Number(rawValue))) return;
        const numValue = Number(rawValue);

        setFormData((prev: any) => {
            const newData = { ...prev, [name]: numValue };

            const newRent = name === 'monthlyRent' ? numValue : (prev.monthlyRent || 0);
            const newMaint = name === 'maintenance' ? numValue : (prev.maintenance || 0);
            newData.rentMaintenance = newRent + newMaint;

            // Recalculate Financials based on new rentMaintenance
            const monthlyRevenue = newData.monthlyRevenue || 0;
            const materialCost = Math.round(monthlyRevenue * ((newData.materialCostPercent || 0) / 100));
            const totalExpense = (newData.laborCost || 0) + newData.rentMaintenance + (newData.taxUtilities || 0) + (newData.maintenanceDepreciation || 0) + (newData.promoMisc || 0) + materialCost;
            newData.monthlyProfit = monthlyRevenue - totalExpense;

            const investment = (newData.deposit || 0) + (newData.premium || 0);
            newData.yieldPercent = investment > 0 ? (newData.monthlyProfit / investment) * 100 : 0;


            // Sync Premium if Briefing Price changes (Delta Logic)
            if (name === 'briefingPrice') {
                const delta = numValue - (prev.briefingPrice || 0);
                newData.premium = (prev.premium || 0) + delta;
            }

            // Auto-calculate total price (Deposit + Premium)
            if (['deposit', 'premium', 'briefingPrice'].includes(name)) {
                newData.totalPrice = (newData.deposit || 0) + (newData.premium || 0);

                // Recalculate Yield if deposit/premium changes
                const monthlyProfit = newData.monthlyProfit || 0;
                const investment = (newData.deposit || 0) + (newData.premium || 0);
                newData.yieldPercent = investment > 0 ? (monthlyProfit / investment) * 100 : 0;
            }
            return newData;
        });
    };

    // Financial Logic (Synced with Register Page)
    const handleFinancialChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        const rawValue = value.replace(/,/g, '');
        if (isNaN(Number(rawValue))) return;
        const numValue = Number(rawValue);

        setFormData((prev: any) => {
            const newData = { ...prev, [name]: numValue };

            const monthlyRevenue = newData.monthlyRevenue || 0;
            const materialCostPercent = newData.materialCostPercent || 0;
            const materialCost = Math.round(monthlyRevenue * (materialCostPercent / 100));
            newData.materialCost = materialCost; // Store calculated material cost

            const totalExpense = (newData.laborCost || 0) + (newData.rentMaintenance || 0) + (newData.taxUtilities || 0) + (newData.maintenanceDepreciation || 0) + (newData.promoMisc || 0) + materialCost;
            newData.monthlyProfit = monthlyRevenue - totalExpense;

            const investment = (newData.deposit || 0) + (newData.premium || 0);
            newData.yieldPercent = investment > 0 ? (newData.monthlyProfit / investment) * 100 : 0;

            return newData;
        });
    };

    const toggleFavorite = () => {
        const newData = { ...formData, isFavorite: !formData.isFavorite };
        setFormData(newData);
        autoSaveProperty(newData);
    };

    // Address Search Handler
    const handleComplete = (data: any) => {
        let fullAddress = data.address;
        let extraAddress = '';

        if (data.addressType === 'R') {
            if (data.bname !== '') extraAddress += data.bname;
            if (data.buildingName !== '') extraAddress += (extraAddress !== '' ? `, ${data.buildingName}` : data.buildingName);
            fullAddress += (extraAddress !== '' ? ` (${extraAddress})` : '');
        }

        setFormData((prev: any) => ({ ...prev, address: fullAddress }));
        setIsSearchOpen(false);

        // Update Map Coordinates
        if (window.kakao && window.kakao.maps && window.kakao.maps.services) {
            const geocoder = new window.kakao.maps.services.Geocoder();
            geocoder.addressSearch(fullAddress, (result: any, status: any) => {
                if (status === window.kakao.maps.services.Status.OK) {
                    setFormData((prev: any) => ({
                        ...prev,
                        coordinates: {
                            lat: Number(result[0].y),
                            lng: Number(result[0].x),
                        }
                    }));
                    setIsMapOpen(true); // Auto open map
                }
            });
        }
    };

    // Brand Search Handlers
    const searchBrands = async () => {
        if (!brandSearchQuery.trim()) return;
        setIsSearchingBrand(true);
        try {
            const res = await fetch(`/api/franchise?query=${encodeURIComponent(brandSearchQuery)}`);
            if (res.ok) {
                const data = await res.json();
                setBrandSearchResults(data);
            }
        } catch (error) {
            console.error('Failed to search brands:', error);
        } finally {
            setIsSearchingBrand(false);
        }
    };

    const handleBrandSelect = (brand: any) => {
        setFormData((prev: any) => ({
            ...prev,
            franchiseBrand: brand.brandNm,
            industryCategory: brand.indutyLclasNm || prev.industryCategory,
            industrySector: brand.indutyMlsfcNm || prev.industrySector
        }));
        setIsBrandSearchOpen(false);
        setBrandSearchResults([]);
        setBrandSearchQuery('');
    };

    // Custom Field Handlers
    const addCustomField = (type: 'operation' | 'lease') => {
        if (type === 'operation') {
            if (newOperationCategory.trim()) {
                const newFields = [...(formData.operationCustomFields || []), { label: newOperationCategory, value: '' }];
                setFormData({ ...formData, operationCustomFields: newFields });
                setNewOperationCategory('');
                setIsAddingOperationCategory(false);
            }
        } else {
            if (newLeaseCategory.trim()) {
                const newFields = [...(formData.leaseCustomFields || []), { label: newLeaseCategory, value: '' }];
                setFormData({ ...formData, leaseCustomFields: newFields });
                setNewLeaseCategory('');
                setIsAddingLeaseCategory(false);
            }
        }
    };

    const handleCustomFieldChange = (type: 'operation' | 'lease', index: number, value: string) => {
        if (type === 'operation') {
            const newFields = [...formData.operationCustomFields];
            newFields[index].value = value;
            setFormData({ ...formData, operationCustomFields: newFields });
        } else {
            const newFields = [...formData.leaseCustomFields];
            newFields[index].value = value;
            setFormData({ ...formData, leaseCustomFields: newFields });
        }
    };

    const formatCurrency = (value: number | string) => {
        if (!value) return '0';
        return Number(value).toLocaleString();
    };

    const formatInput = (value: number | undefined | null) => {
        if (value === undefined || value === null || value === 0 || Number.isNaN(value)) return '';
        return value.toLocaleString();
    };

    const addScheduleEvent = async (title: string, date: string, type: string = 'work', color: string = '#7950f2', propertyId?: string, details?: string, additionalProps: any = {}) => {
        try {
            const getUserInfo = () => {
                const userStr = localStorage.getItem('user');
                if (userStr) {
                    const parsed = JSON.parse(userStr);
                    const user = parsed.user || parsed; // Handle wrapped 'user' object
                    return { userId: user.id, companyName: user.companyName || '' };
                }
                return { userId: '', companyName: '' };
            };
            const { userId, companyName } = getUserInfo();

            await fetch('/api/schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    date,
                    scope: 'work',
                    status: 'completed',
                    type,
                    color,
                    details: details || '?먮룞 ?앹꽦???댁뿭?낅땲??',
                    propertyId,
                    userId,
                    companyName,
                    ...additionalProps // Merge additional props (customerId, etc.)
                })
            });
        } catch (error) {
            console.error('Failed to add schedule event:', error);
        }
    };

    const handleSave = async () => {
        if (!window.confirm('??ν븯?쒓쿋?듬땲源?')) return;
        setIsLoading(true);
        try {
            const isNew = !formData.id;
            const method = isNew ? 'POST' : 'PUT';
            const url = isNew ? '/api/properties' : `/api/properties?id=${formData.id}`;

            // Auto-add Price History if changed (Request 3)
            const lastHistory = formData.priceHistory && formData.priceHistory.length > 0
                ? formData.priceHistory[formData.priceHistory.length - 1]
                : null;

            const currentTotal = Number(formData.totalPrice) || 0;
            const lastTotal = lastHistory ? Number(lastHistory.amount) : -1; // -1 to force add if no history

            let finalFormData = { ...formData };

            // Ensure companyName is present for data isolation
            if (!finalFormData.companyName) {
                const userStr = localStorage.getItem('user');
                if (userStr) {
                    const parsed = JSON.parse(userStr);
                    const user = parsed.user || parsed; // Handle wrapped 'user' object
                    finalFormData.companyName = user.companyName;
                }
            }

            if (currentTotal !== lastTotal) {
                const newHistoryItem: PriceHistoryItem = {
                    id: Date.now().toString(),
                    date: new Date().toISOString().split('T')[0],
                    manager: formData.managerName || 'Unknown',
                    amount: currentTotal,
                    isImportant: false,
                    details: isNew ? '?좉퇋 ?깅줉 (?먮룞???' : '湲덉븸 ?뺣낫 ?섏젙 (?먮룞???'
                };
                const newHistory = [...(formData.priceHistory || []), newHistoryItem];
                finalFormData.priceHistory = newHistory;

                // Moved addScheduleEvent logic to after success response
                // ...
            }

            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalFormData),
            });

            if (res.ok) {
                const savedData = await res.json();
                alert('??λ릺?덉뒿?덈떎.');

                // Update local state with saved data
                setFormData(savedData);

                // Add Schedule Event AFTER Save (so we have ID)
                if (currentTotal !== lastTotal) {
                    const statusMap: Record<string, string> = {
                        'progress': '吏꾪뻾',
                        'manage': '愿由?,
                        'hold': '蹂대쪟',
                        'joint': '怨듬룞',
                        'complete': '?꾨즺'
                    };

                    const statusText = statusMap[savedData.status] || '吏꾪뻾';
                    const eventTitle = isNew
                        ? `[?좉퇋] [${savedData.name || '臾대챸'}] 쨌 (${formatCurrency(currentTotal)} 留뚯썝)`
                        : `[湲덉븸蹂?? [${savedData.name}] 쨌 (${formatCurrency(currentTotal)} 留뚯썝)`;

                    // Colors: New=#7950f2 (Purple), PriceChange=#fd7e14 (Orange)
                    const eventColor = isNew ? '#7950f2' : '#fd7e14';

                    await addScheduleEvent(
                        eventTitle,
                        new Date().toISOString().split('T')[0],
                        isNew ? 'work' : 'price_change', // Differentiate type if needed
                        eventColor,
                        savedData.id // Use the confirmed ID
                    );
                }

                // Notify parent list to refresh immediately
                if (onRefresh) {
                    onRefresh();
                }
            } else {
                alert('??μ뿉 ?ㅽ뙣?덉뒿?덈떎.');
            }
        } catch (error) {
            console.error('Failed to save property:', error);
            alert('?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!formData.id) {
            alert('??λ릺吏 ?딆? 臾쇨굔?낅땲??');
            return;
        }
        if (!window.confirm('?뺣쭚 ??젣?섏떆寃좎뒿?덇퉴?')) return;
        setIsLoading(true);
        try {
            const res = await fetch(`/api/properties?id=${formData.id}`, {
                method: 'DELETE',
            });
            if (res.ok) {
                alert('??젣?섏뿀?듬땲??');
                if (onRefresh) onRefresh();
                onClose();
            } else {
                alert('??젣???ㅽ뙣?덉뒿?덈떎.');
            }
        } catch (error) {
            console.error(error);
            alert('?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        } finally {
            setIsLoading(false);
        }
    };

    const showToast = (message: string) => {
        setToast({ message, visible: true });
        setTimeout(() => {
            setToast(prev => ({ ...prev, visible: false }));
        }, 4000); // 4 seconds total (matches animation)
    };

    const handleNew = () => {
        if (!window.confirm('?묒꽦 以묒씤 ?댁슜??珥덇린?붾맗?덈떎. ?좉퇋 臾쇨굔???묒꽦?섏떆寃좎뒿?덇퉴?')) return;

        const emptyData = {
            name: '',
            status: 'progress',
            priceHistory: [],
            workHistory: [],
            managerId: '',
            managerName: ''
        };

        // Inject company info and manager info
        const userStr = localStorage.getItem('user');
        if (userStr) {
            const parsed = JSON.parse(userStr);
            const user = parsed.user || parsed; // Handle wrapped 'user' object
            (emptyData as any).companyName = user.companyName;
            (emptyData as any).managerId = user.id;
            (emptyData as any).managerName = user.name;
        }

        setFormData(emptyData);
    };

    const handleCopy = async () => {
        if (!window.confirm('?꾩옱 臾쇨굔??蹂듭궗?섏뿬 ?덈줈??臾쇨굔???앹꽦?섏떆寃좎뒿?덇퉴?')) return;
        setIsLoading(true);
        try {
            // Clone formData and modify for new entry
            const { id, ...rest } = formData;
            const newProperty = {
                ...rest,
                name: `${formData.name} (蹂듭궗蹂?`,
                createdAt: new Date().toISOString(),
            };

            // Ensure companyName is present check
            if (!newProperty.companyName) {
                const userStr = localStorage.getItem('user');
                if (userStr) {
                    const parsed = JSON.parse(userStr);
                    const user = parsed.user || parsed; // Handle wrapped 'user' object
                    newProperty.companyName = user.companyName;
                }
            }

            const res = await fetch('/api/properties', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newProperty),
            });

            if (res.ok) {
                const createdProperty = await res.json();

                // Add to Schedule (New Property from Copy)
                const totalPrice = (createdProperty.deposit || 0) + (createdProperty.premium || 0) + (createdProperty.briefingPrice || 0);
                const scheduleTitle = `[?좉퇋] [${createdProperty.name}] 쨌 (${formatCurrency(totalPrice)} 留뚯썝)`;
                await addScheduleEvent(scheduleTitle, new Date().toISOString().split('T')[0], 'work', '#7950f2', createdProperty.id);

                alert('臾쇨굔??蹂듭궗?섏뿀?듬땲??');
                if (onRefresh) onRefresh();
                onClose();
            } else {
                alert('蹂듭궗???ㅽ뙣?덉뒿?덈떎.');
            }
        } catch (error) {
            console.error(error);
            alert('?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        } finally {
            setIsLoading(false);
        }
    };

    // Document State & Handlers
    const docInputRef = React.useRef<HTMLInputElement>(null);
    const [selectedDocIds, setSelectedDocIds] = useState<string[]>([]);

    // Updated Interface in implementation (needs to be consistent with top of file, but here we modify usage)
    // IMPORTANT: Ideally I should update the interface definition at the top of the file too.
    // However, since I am replacing a block in the middle, I cannot easily reach the top interface definition in the same tool call without reading it all specifically.
    // TypeScript might complain if I use 'path' property without updating interface.
    // I will try to use 'any' casting or rely on the previous ViewFile showing I can maybe reach it? 
    // Wait, the interface is at line 105. I should probably update that in a separate call or hope TS is lenient/inferred.
    // Re-reading: The replacement target is lines 1892-1956.
    // The Interface update is necessary. I will handle Interface update in a separate MultiReplace or just cast to any for now to ensure runtime works, then cleanup.
    // Actually, I can allow implicit typing or just cast `newDocs` item.

    const handleDocUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        setIsLoading(true); // Show loading state
        const newDocs: PropertyDocument[] = [];
        const maxSize = 50 * 1024 * 1024; // 50MB
        const supabase = getSupabase();

        const userStr = localStorage.getItem('user');
        let userName = 'Unknown';
        if (userStr) {
            const user = JSON.parse(userStr);
            userName = (user.user || user).name || 'Unknown'; // Simplified
        }

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > maxSize) {
                    alert(`?뚯씪 '${file.name}'???⑸웾??50MB瑜?珥덇낵?섏뿬 ?쒖쇅?⑸땲??`);
                    continue;
                }

                const ext = file.name.split('.').pop()?.toLowerCase() || 'unknown';

                // 1. Upload to Supabase Storage
                // Path: properties/{propertyId}/{timestamp}_{filename}
                const timestamp = Date.now();
                // Sanitize filename to avoid weird character issues
                const sanitizedName = file.name.replace(/[^\x00-\x7F]/g, "_");
                const filePath = `properties/${property.id || 'temp'}/${timestamp}_${sanitizedName}`;

                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('property-documents')
                    .upload(filePath, file);

                if (uploadError) {
                    console.error('Upload error:', uploadError);
                    alert(`Upload failed for ${file.name}: ${uploadError.message}`);
                    continue;
                }

                // 2. Get Public URL
                const { data: urlData } = supabase.storage
                    .from('property-documents')
                    .getPublicUrl(filePath);

                // 3. Create Document Metadata
                newDocs.push({
                    id: timestamp.toString() + Math.random().toString().substr(2, 5),
                    date: new Date().toISOString().split('T')[0],
                    uploader: userName,
                    type: ext,
                    name: file.name,
                    size: file.size,
                    url: urlData.publicUrl,
                    path: filePath // Store path for deletion
                } as PropertyDocument);
            }

            if (newDocs.length > 0) {
                const currentDocs = formData.documents || [];
                const updatedDocs = [...newDocs, ...currentDocs];
                const updatedFormData = { ...formData, documents: updatedDocs };
                setFormData(updatedFormData);
                await autoSaveProperty(updatedFormData);
                alert(`${newDocs.length}媛쒖쓽 臾몄꽌媛 ?깅줉?섏뿀?듬땲??`);
            }
        } catch (error) {
            console.error('Doc upload process error:', error);
            alert('臾몄꽌 ?낅줈??以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        } finally {
            setIsLoading(false);
            if (docInputRef.current) docInputRef.current.value = '';
        }
    };

    const handleDeleteDocuments = async () => {
        if (selectedDocIds.length === 0) {
            alert('??젣??臾몄꽌瑜??좏깮?댁＜?몄슂.');
            return;
        }
        if (!confirm(`${selectedDocIds.length}媛쒖쓽 臾몄꽌瑜???젣?섏떆寃좎뒿?덇퉴?`)) return;

        setIsLoading(true);
        const supabase = getSupabase();

        try {
            const currentDocs = formData.documents || [];

            // 1. Find files to delete from Storage (those with 'path')
            const docsToDelete = currentDocs.filter((doc: any) => selectedDocIds.includes(doc.id));
            const pathsToDelete = docsToDelete
                .filter((doc: any) => doc.path)
                .map((doc: any) => doc.path);

            if (pathsToDelete.length > 0) {
                const { error: deleteError } = await supabase.storage
                    .from('property-documents')
                    .remove(pathsToDelete);

                if (deleteError) {
                    console.error('Storage delete error:', deleteError);
                    // Decide whether to stop or continue. Usually safe to continue removing metadata.
                    // alert('Error deleting files from storage, but metadata will be removed.');
                }
            }

            // 2. Remove from State
            const updatedDocs = currentDocs.filter((doc: any) => !selectedDocIds.includes(doc.id));
            const updatedFormData = { ...formData, documents: updatedDocs };

            setFormData(updatedFormData);
            setSelectedDocIds([]);
            await autoSaveProperty(updatedFormData);
        } catch (error) {
            console.error('Delete docs error:', error);
            alert('臾몄꽌 ??젣 以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleFranchiseChange = (e: React.ChangeEvent<HTMLInputElement>, field: string) => {
        const val = e.target.value.replace(/,/g, '');
        if (val === '') {
            setFormData((prev: any) => ({ ...prev, [field]: 0 }));
            return;
        }
        if (isNaN(Number(val))) return;
        setFormData((prev: any) => ({ ...prev, [field]: Number(val) }));
    };

    const handleMultiSelect = (e: React.ChangeEvent<HTMLInputElement>, field: string) => {
        const { value, checked } = e.target;
        setFormData((prev: any) => {
            const currentStr = prev[field] || '';
            const currentArr = currentStr ? currentStr.split(',').map((s: string) => s.trim()) : [];

            let newArr;
            if (checked) {
                if (!currentArr.includes(value)) newArr = [...currentArr, value];
                else newArr = currentArr;
            } else {
                newArr = currentArr.filter((item: string) => item !== value);
            }

            return { ...prev, [field]: newArr.join(', ') };
        });
    };

    const getDocIcon = (type: string) => {
        const t = type.toLowerCase();
        if (['pdf'].includes(t)) return <span style={{ backgroundColor: '#ff6b6b', color: 'white', padding: '2px 6px', borderRadius: 4, fontSize: 11, fontWeight: 'bold' }}>PDF</span>;
        if (['xls', 'xlsx', 'csv'].includes(t)) return <span style={{ backgroundColor: '#217346', color: 'white', padding: '2px 6px', borderRadius: 4, fontSize: 11, fontWeight: 'bold' }}>EXCEL</span>;
        if (['doc', 'docx'].includes(t)) return <span style={{ backgroundColor: '#2b579a', color: 'white', padding: '2px 6px', borderRadius: 4, fontSize: 11, fontWeight: 'bold' }}>WORD</span>;
        if (['ppt', 'pptx'].includes(t)) return <span style={{ backgroundColor: '#d24726', color: 'white', padding: '2px 6px', borderRadius: 4, fontSize: 11, fontWeight: 'bold' }}>PPT</span>;
        if (['jpg', 'png', 'jpeg', 'gif'].includes(t)) return <span style={{ backgroundColor: '#1098ad', color: 'white', padding: '2px 6px', borderRadius: 4, fontSize: 11, fontWeight: 'bold' }}>IMG</span>;
        if (['zip', 'rar', '7z'].includes(t)) return <span style={{ backgroundColor: '#fcc419', color: 'white', padding: '2px 6px', borderRadius: 4, fontSize: 11, fontWeight: 'bold' }}>ZIP</span>;
        return <span style={{ backgroundColor: '#868e96', color: 'white', padding: '2px 6px', borderRadius: 4, fontSize: 11, fontWeight: 'bold' }}>ETC</span>;
    };

    const toggleSection = (section: keyof typeof openSections) => {
        setOpenSections(prev => ({ ...prev, [section]: !prev[section] }));
    };

    return (
        <div className={styles.cardContainer}>
            {/* Header */}
            <div className={styles.header}>
                <div className={styles.titleSection}>
                    <div style={{ display: 'flex', gap: 6, marginBottom: 4 }}>
                        {formData.processStatus && (
                            <span style={{
                                backgroundColor: '#7950f2',
                                color: 'white',
                                padding: '2px 8px',
                                borderRadius: '4px',
                                fontSize: '12px',
                                fontWeight: 'bold'
                            }}>
                                {formData.processStatus}
                            </span>
                        )}
                    </div>
                    <input
                        name="name"
                        className={styles.titleInput}
                        value={formData.name || ''}
                        onChange={handleChange}
                        placeholder="臾쇨굔紐?
                    />
                </div>
                <div style={{ display: 'flex', alignItems: 'center', marginRight: '20px' }}>
                    <div
                        onClick={toggleFavorite}
                        style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', padding: '4px', marginRight: '8px' }}
                    >
                        <Star
                            size={20}
                            fill={formData.isFavorite ? "#fab005" : "none"}
                            color={formData.isFavorite ? "#fab005" : "#adb5bd"}
                        />
                    </div>
                    <div className={styles.managerInfo}>
                        <User size={14} />
                        <select
                            name="managerId"
                            value={formData.managerId || ''}
                            onChange={handleManagerChange}
                            className={styles.managerSelect}
                        >
                            <option value="">?대떦??誘몄???/option>
                            {managers.map(mgr => (
                                <option key={mgr.id} value={mgr.id}>
                                    {mgr.name}
                                </option>
                            ))}
                        </select>
                    </div>
                </div>
            </div >

            <div className={styles.mainLayout}>
                {/* Left Side: Property Details Form (Table Style) */}
                <div className={styles.leftPanel}>

                    {/* 1. 臾쇨굔媛쒖슂 (Overview) */}
                    <div className={styles.sectionRow}>
                        <div
                            className={styles.verticalHeader}
                            onClick={() => toggleSection('overview')}
                            style={{ cursor: 'pointer' }}
                        >臾?br />嫄?br />媛?br />??/div>
                        {openSections.overview && (
                            <div className={styles.contentArea}>
                                <div className={styles.fieldGrid}>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>臾쇨굔紐?/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="name" className={styles.input} value={formData.name || ''} onChange={handleChange} />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?낆쥌</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <div style={{ display: 'flex', gap: 4, width: '100%' }}>
                                                {/* Level 1: Industry Category */}
                                                <select
                                                    name="industryCategory"
                                                    className={styles.select}
                                                    value={formData.industryCategory || ''}
                                                    onChange={(e) => {
                                                        setFormData((prev: any) => ({
                                                            ...prev,
                                                            industryCategory: e.target.value,
                                                            industrySector: '', // Reset Level 2
                                                            industryDetail: '' // Reset Level 3
                                                        }));
                                                    }}
                                                >
                                                    <option value="">?遺꾨쪟</option>
                                                    {Object.keys(INDUSTRY_DATA).map(cat => (
                                                        <option key={cat} value={cat}>{cat}</option>
                                                    ))}
                                                </select>

                                                {/* Level 2: Industry Sector (Category) */}
                                                <select
                                                    name="industrySector"
                                                    className={styles.select}
                                                    value={formData.industrySector || ''}
                                                    onChange={(e) => {
                                                        const newVal = e.target.value;
                                                        const details = (formData.industryCategory && INDUSTRY_DATA[formData.industryCategory])
                                                            ? (INDUSTRY_DATA[formData.industryCategory][newVal] || [])
                                                            : [];
                                                        setFormData((prev: any) => ({
                                                            ...prev,
                                                            industrySector: newVal,
                                                            // Auto select if no details (use sector) or single detail (use detail)
                                                            industryDetail: details.length === 0 ? newVal : (details.length === 1 ? details[0] : '')
                                                        }));
                                                    }}
                                                    disabled={!formData.industryCategory}
                                                >
                                                    <option value="">以묐텇瑜?/option>
                                                    {formData.industryCategory && Object.keys(INDUSTRY_DATA[formData.industryCategory] || {}).map(sec => (
                                                        <option key={sec} value={sec}>{sec}</option>
                                                    ))}
                                                </select>

                                                {/* Level 3: Industry Detail */}
                                                <select
                                                    name="industryDetail"
                                                    className={styles.select}
                                                    value={formData.industryDetail || ''}
                                                    onChange={handleChange}
                                                    disabled={!formData.industrySector || !formData.industryCategory || !INDUSTRY_DATA[formData.industryCategory] || (INDUSTRY_DATA[formData.industryCategory][formData.industrySector]?.length === 0)}
                                                    style={(!formData.industrySector || !formData.industryCategory || !INDUSTRY_DATA[formData.industryCategory] || (INDUSTRY_DATA[formData.industryCategory][formData.industrySector]?.length === 0)) ? { backgroundColor: '#e9ecef' } : {}}
                                                >
                                                    <option value="">?뚮텇瑜?/option>
                                                    {/* If no details, show the category name as option or simple hidden? User said "auto select". */}
                                                    {formData.industryCategory && formData.industrySector && INDUSTRY_DATA[formData.industryCategory] && (
                                                        (INDUSTRY_DATA[formData.industryCategory][formData.industrySector]?.length > 0) ? (
                                                            INDUSTRY_DATA[formData.industryCategory][formData.industrySector].map(det => (
                                                                <option key={det} value={det}>{det}</option>
                                                            ))
                                                        ) : (
                                                            // If empty details, show the selected sector as the only option (auto-selected)
                                                            <option value={formData.industrySector}>{formData.industrySector}</option>
                                                        )
                                                    )}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>臾쇨굔?깃툒</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <div style={{ display: 'flex', gap: 8 }}>
                                                {['異붿쭊', '愿由?, '蹂대쪟', '怨듬룞', '?꾨즺'].map(status => (
                                                    <label key={status} style={{ display: 'flex', alignItems: 'center', gap: 4, fontSize: 12 }}>
                                                        <input
                                                            type="radio"
                                                            name="status"
                                                            value={status === '異붿쭊' ? 'progress' : status === '愿由? ? 'manage' : status === '蹂대쪟' ? 'hold' : status === '怨듬룞' ? 'joint' : 'complete'}
                                                            checked={formData.status === (status === '異붿쭊' ? 'progress' : status === '愿由? ? 'manage' : status === '蹂대쪟' ? 'hold' : status === '怨듬룞' ? 'joint' : 'complete')}
                                                            onChange={handleChange}
                                                        />
                                                        {status}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>吏꾪뻾?곹솴</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap' }}>
                                                {['怨꾩빟?곹솴', '怨꾩빟?꾨즺', '湲덉븸?묒뾽', '愿묎퀬以?, '?좉퇋?낆젏', '?묐룄?묒닔', '援먰솚臾쇨굔'].map(item => (
                                                    <label key={item} style={{ display: 'flex', alignItems: 'center', gap: 4, fontSize: 12, cursor: 'pointer' }}>
                                                        <input
                                                            type="radio"
                                                            name="processStatus"
                                                            value={item}
                                                            checked={formData.processStatus === item}
                                                            onChange={handleChange}
                                                        />
                                                        {item}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?댁쁺?뺥깭</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <div style={{ display: 'flex', gap: 8 }}>
                                                {['吏곸쁺', '??ㅽ넗', '諛섏삤??, '?꾪긽', '蹂몄궗'].map(type => (
                                                    <label key={type} style={{ display: 'flex', alignItems: 'center', gap: 4, fontSize: 12 }}>
                                                        <input
                                                            type="checkbox"
                                                            name="operationType"
                                                            value={type}
                                                            checked={formData.operationType?.includes(type)}
                                                            onChange={(e) => handleMultiSelect(e, 'operationType')}
                                                        />
                                                        {type}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?뚯옱吏</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3', flexDirection: 'column', alignItems: 'flex-start', gap: 4 }}>
                                            <div style={{ display: 'flex', width: '100%', gap: 4 }}>
                                                <input name="address" className={styles.input} value={formData.address || ''} readOnly onClick={() => setIsSearchOpen(true)} placeholder="二쇱냼 寃?? />
                                                <button
                                                    type="button"
                                                    onClick={() => setIsSearchOpen(true)}
                                                    className={styles.smallBtn}
                                                >
                                                    <Search size={14} />
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setIsMapOpen(!isMapOpen)}
                                                    className={styles.smallBtn}
                                                    style={{ width: 'auto', whiteSpace: 'nowrap' }}
                                                >
                                                    {isMapOpen ? <ChevronUp size={14} /> : <ChevronDown size={14} />} 吏??                                                </button>
                                            </div>
                                            {isMapOpen && formData.coordinates && (
                                                <div style={{ width: '100%', height: '200px', marginTop: 4, border: '1px solid #dee2e6' }}>
                                                    <Map
                                                        center={{ lat: formData.coordinates.lat, lng: formData.coordinates.lng }}
                                                        style={{ width: "100%", height: "100%" }}
                                                        level={3}
                                                    >
                                                        <MapMarker position={{ lat: formData.coordinates.lat, lng: formData.coordinates.lng }} />
                                                    </Map>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?곸꽭二쇱냼</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="detailAddress" className={styles.input} value={formData.detailAddress || ''} onChange={handleChange} />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>硫댁쟻</div>
                                        <div className={styles.fieldValue}>
                                            <input
                                                name="area"
                                                type="number"
                                                className={styles.input}
                                                value={getDisplayArea()}
                                                onChange={handleAreaChange}
                                                placeholder={areaUnit === 'pyeong' ? '?됱닔' : 'm짼'}
                                            />
                                            <div
                                                onClick={() => setAreaUnit(prev => prev === 'pyeong' ? 'm2' : 'pyeong')}
                                                style={{
                                                    fontSize: 12,
                                                    marginLeft: 4,
                                                    cursor: 'pointer',
                                                    backgroundColor: '#f1f3f5',
                                                    padding: '2px 6px',
                                                    borderRadius: 4,
                                                    minWidth: 30,
                                                    textAlign: 'center',
                                                    userSelect: 'none',
                                                    border: '1px solid #dee2e6'
                                                }}
                                                title="?대┃?섏뿬 ?⑥쐞 蹂寃?(??<-> m짼)"
                                            >
                                                {areaUnit === 'pyeong' ? '?? : 'm짼'}
                                            </div>
                                        </div>
                                        <div className={styles.fieldLabel}>痢듭닔</div>
                                        <div className={styles.fieldValue}>
                                            <input name="totalFloor" className={styles.input} style={{ width: 40 }} value={formData.totalFloor || ''} onChange={handleChange} />
                                            <span style={{ margin: '0 4px' }}>痢?以?/span>
                                            <input name="currentFloor" className={styles.input} style={{ width: 40 }} value={formData.currentFloor || ''} onChange={handleChange} />
                                            <span style={{ marginLeft: 4 }}>痢?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>二쇱감</div>
                                        <div className={styles.fieldValue}>
                                            <input name="parking" className={styles.input} value={formData.parking || ''} onChange={handleChange} />
                                        </div>
                                        <div className={styles.fieldLabel}>媛쒖뾽??/div>
                                        <div className={styles.fieldValue}>
                                            <input name="openingDate" type="date" className={styles.input} value={formData.openingDate || ''} onChange={handleChange} />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?꾨옖李⑥씠利?/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <div style={{ display: 'flex', gap: 4, width: '100%' }}>
                                                <input name="franchiseBrand" className={styles.input} value={formData.franchiseBrand || ''} readOnly placeholder="釉뚮옖?쒕챸" />
                                                <button
                                                    type="button"
                                                    onClick={() => setIsBrandSearchOpen(true)}
                                                    className={styles.smallBtn}
                                                    style={{ width: 'auto', whiteSpace: 'nowrap' }}
                                                >
                                                    <Search size={14} /> 寃??                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?꾩튂/?곴텒</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <textarea name="locationMemo" className={styles.textarea} value={formData.locationMemo || ''} onChange={handleChange} placeholder="?꾩튂 諛??곴텒 ?뱀쭠???낅젰?섏꽭?? />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?뱀쭠</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <textarea name="featureMemo" className={styles.textarea} value={formData.featureMemo || ''} onChange={handleChange} placeholder="臾쇨굔 ?뱀쭠???낅젰?섏꽭?? />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>硫붾え</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <textarea name="overviewMemo" className={styles.textarea} value={formData.overviewMemo || ''} onChange={handleChange} placeholder="湲고? 硫붾え瑜??낅젰?섏꽭?? />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* 2. ?곕씫泥섏젙蹂?(Contact) */}
                    <div className={styles.sectionRow}>
                        <div
                            className={styles.verticalHeader}
                            style={{ backgroundColor: '#e64980', cursor: 'pointer' }}
                            onClick={() => toggleSection('contact')}
                        >??br />??br />泥?/div>
                        {openSections.contact && (
                            <div className={styles.contentArea}>
                                <div className={styles.fieldGrid}>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?낆냼?꾪솕</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="storePhone" className={styles.input} value={formData.storePhone || ''} onChange={handleChange} />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?꾨???/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="landlordName" className={styles.input} placeholder="?대쫫" value={formData.landlordName || ''} onChange={handleChange} style={{ width: '30%', marginRight: 8 }} />
                                            <input name="landlordPhone" className={styles.input} placeholder="?곕씫泥? value={formData.landlordPhone || ''} onChange={handleChange} style={{ width: '60%' }} />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?꾩감??/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="tenantName" className={styles.input} placeholder="?대쫫" value={formData.tenantName || ''} onChange={handleChange} style={{ width: '30%', marginRight: 8 }} />
                                            <input name="tenantPhone" className={styles.input} placeholder="?곕씫泥? value={formData.tenantPhone || ''} onChange={handleChange} style={{ width: '60%' }} />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>湲고?</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="otherContactName" className={styles.input} placeholder="?대쫫" value={formData.otherContactName || ''} onChange={handleChange} style={{ width: '30%', marginRight: 8 }} />
                                            <input name="otherContactPhone" className={styles.input} placeholder="?곕씫泥? value={formData.otherContactPhone || ''} onChange={handleChange} style={{ width: '60%' }} />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?곕씫泥섎찓紐?/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="contactMemo" className={styles.input} value={formData.contactMemo || ''} onChange={handleChange} placeholder="?곕씫泥?愿???뱀씠?ы빆" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* 3. 湲덉븸?뺣낫 (Price) */}
                    <div className={styles.sectionRow}>
                        <div
                            className={styles.verticalHeader}
                            style={{ backgroundColor: '#7950f2', cursor: 'pointer' }}
                            onClick={() => toggleSection('price')}
                        >湲?br />??br />??br />蹂?/div>
                        {openSections.price && (
                            <div className={styles.contentArea}>
                                <div className={styles.fieldGrid}>
                                    {/* Left: Capital */}
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>蹂댁쬆湲?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="deposit" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.deposit)} onChange={handlePriceChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                        <div className={styles.fieldLabel}>?붿엫?猷?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="monthlyRent" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.monthlyRent)} onChange={handlePriceChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>沅뚮━湲?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="premium" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.premium)} onChange={handlePriceChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                        <div className={styles.fieldLabel}>愿由щ퉬</div>
                                        <div className={styles.fieldValue}>
                                            <input name="maintenance" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.maintenance)} onChange={handlePriceChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>釉뚮━?묎?</div>
                                        <div className={styles.fieldValue}>
                                            <input name="briefingPrice" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.briefingPrice)} onChange={handlePriceChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                        <div className={styles.fieldLabel}>遺媛??/div>
                                        <div className={styles.fieldValue}>
                                            <div style={{ display: 'flex', gap: '12px', alignItems: 'center', height: '100%' }}>
                                                {['蹂꾨룄', '?ы븿'].map(option => (
                                                    <label key={option} style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer', marginBottom: 0 }}>
                                                        <input
                                                            type="radio"
                                                            name="vat"
                                                            value={option}
                                                            checked={formData.vat === option}
                                                            onChange={handleChange}
                                                        />
                                                        <span style={{ fontSize: '12px' }}>{option}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            {/* <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span> - Removed for radio */}
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel} style={{ backgroundColor: '#ffe3e3', color: '#c92a2a', fontWeight: 'bold' }}>?⑷퀎湲?/div>
                                        <div className={styles.fieldValue} style={{ backgroundColor: '#ffe3e3' }}>
                                            <span className={styles.totalPrice}>{formatCurrency(formData.totalPrice)}</span>
                                            <span style={{ fontSize: 12, marginLeft: 4, color: '#c92a2a', fontWeight: 'bold' }}>留?/span>
                                        </div>
                                        <div className={styles.fieldLabel}></div>
                                        <div className={styles.fieldValue}></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Franchise Status (Moved from Right Tab) */}
                    <div className={styles.sectionRow}>
                        <div
                            className={styles.verticalHeader}
                            style={{ backgroundColor: '#15aabf', cursor: 'pointer' }}
                            onClick={() => toggleSection('franchise')}
                        >媛<br />留?br />??br />??/div>
                        {openSections.franchise && (
                            <div className={styles.contentArea}>
                                <div className={styles.fieldGrid}>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>蹂몄궗蹂댁쬆湲?/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="text"
                                                className={`${styles.input} ${styles.priceInput}`}
                                                value={formatInput(formData.hqDeposit)}
                                                onChange={(e) => handleFranchiseChange(e, 'hqDeposit')}
                                                placeholder="0"
                                            />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>媛留밸퉬</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="text"
                                                className={`${styles.input} ${styles.priceInput}`}
                                                value={formatInput(formData.franchiseFee)}
                                                onChange={(e) => handleFranchiseChange(e, 'franchiseFee')}
                                                placeholder="0"
                                            />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>援먯쑁鍮?/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="text"
                                                className={`${styles.input} ${styles.priceInput}`}
                                                value={formatInput(formData.educationFee)}
                                                onChange={(e) => handleFranchiseChange(e, 'educationFee')}
                                                placeholder="0"
                                            />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>由щ돱??/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="text"
                                                className={`${styles.input} ${styles.priceInput}`}
                                                value={formatInput(formData.renewal)}
                                                onChange={(e) => handleFranchiseChange(e, 'renewal')}
                                                placeholder="0"
                                            />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>濡쒖뿴????</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="text"
                                                className={`${styles.input} ${styles.priceInput}`}
                                                value={formatInput(formData.royalty)}
                                                onChange={(e) => handleFranchiseChange(e, 'royalty')}
                                                placeholder="0"
                                            />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel} style={{ fontWeight: 'bold', color: '#15aabf' }}>?⑷퀎湲?/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="text"
                                                className={`${styles.input} ${styles.priceInput}`}
                                                style={{ fontWeight: 'bold', color: '#15aabf', backgroundColor: '#f8f9fa' }}
                                                value={formatCurrency((Number(formData.hqDeposit) || 0) + (Number(formData.franchiseFee) || 0) + (Number(formData.educationFee) || 0) + (Number(formData.renewal) || 0))}
                                                readOnly
                                            />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>硫붾え</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <textarea name="franchiseMemo" className={styles.textarea} value={formData.franchiseMemo || ''} onChange={handleChange} placeholder="媛留?愿??硫붾え瑜??낅젰?섏꽭?? />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* 4. 留ㅼ텧吏異쒕텇??(Revenue/Expense) */}
                    <div className={styles.sectionRow}>
                        <div
                            className={styles.verticalHeader}
                            style={{ backgroundColor: '#339af0', cursor: 'pointer' }}
                            onClick={() => toggleSection('revenue')}
                        >留?br />異?br />??br />??/div>
                        {openSections.revenue && (
                            <div className={styles.contentArea}>
                                <div className={styles.fieldGrid}>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?붿킑留ㅼ텧</div>
                                        <div className={styles.fieldValue}>
                                            <input name="monthlyRevenue" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.monthlyRevenue)} onChange={handleFinancialChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                        <div className={styles.fieldLabel}>?멸굔鍮?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="laborCost" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.laborCost)} onChange={handleFinancialChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?щ즺鍮?%)</div>
                                        <div className={styles.fieldValue}>
                                            <input name="materialCostPercent" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.materialCostPercent)} onChange={handleFinancialChange} style={{ width: '60px' }} placeholder="0" />
                                            <span style={{ fontSize: 12, margin: '0 4px' }}>%</span>
                                            <span style={{ fontSize: 12, color: '#868e96' }}>({formatCurrency(formData.materialCost)})</span>
                                        </div>
                                        <div className={styles.fieldLabel}>?꾨?愿由щ퉬</div>
                                        <div className={styles.fieldValue}>
                                            <input name="rentMaintenance" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.rentMaintenance)} onChange={handleFinancialChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?쒖꽭怨듦낵湲?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="taxUtilities" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.taxUtilities)} onChange={handleFinancialChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                        <div className={styles.fieldLabel}>?좎?蹂댁닔</div>
                                        <div className={styles.fieldValue}>
                                            <input name="maintenanceDepreciation" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.maintenanceDepreciation)} onChange={handleFinancialChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>湲고?寃쎈퉬</div>
                                        <div className={styles.fieldValue}>
                                            <input name="promoMisc" type="text" className={`${styles.input} ${styles.priceInput}`} value={formatInput(formData.promoMisc)} onChange={handleFinancialChange} placeholder="0" />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                        </div>
                                        <div className={styles.fieldLabel} style={{ fontWeight: 'bold' }}>?붿닚?섏씡</div>
                                        <div className={styles.fieldValue}>
                                            <span style={{ fontWeight: 'bold', color: '#f08c00' }}>{formatCurrency(formData.monthlyProfit)} 留?/span>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?섏씡瑜?/div>
                                        <div className={styles.fieldValue}>
                                            <span style={{ fontWeight: 'bold', color: '#fa5252' }}>
                                                {formData.yieldPercent ? Number(formData.yieldPercent).toFixed(2) : '0.00'}%
                                            </span>
                                        </div>
                                        <div className={styles.fieldLabel}>留ㅼ텧?ㅽ뵂?щ?</div>
                                        <div className={styles.fieldValue}>
                                            <select name="revenueOpen" className={styles.select} value={formData.revenueOpen || ''} onChange={handleChange}>
                                                <option value="">?좏깮</option>
                                                <option value="怨듦컻">怨듦컻</option>
                                                <option value="議곌굔遺怨듦컻">議곌굔遺怨듦컻</option>
                                                <option value="鍮꾧났媛?>鍮꾧났媛?/option>
                                                <option value="?묒쓽">?묒쓽</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>留ㅼ텧/吏異?硫붾え</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <textarea name="revenueMemo" className={styles.textarea} value={formData.revenueMemo || ''} onChange={handleChange} placeholder="留ㅼ텧 諛?吏異?愿???뱀씠?ы빆" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* 5. ?곸뾽?꾪솴 (Operation Status) */}
                    <div className={styles.sectionRow}>
                        <div
                            className={styles.verticalHeader}
                            style={{ backgroundColor: '#82c91e', cursor: 'pointer' }}
                            onClick={() => toggleSection('operation')}
                        >??br />??br />??br />??/div>
                        {openSections.operation && (
                            <div className={styles.contentArea}>
                                <div className={styles.fieldGrid}>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?쒖꽕/?명뀒由ъ뼱</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="facilityInterior" className={styles.input} value={formData.facilityInterior || ''} onChange={handleChange} placeholder="?? ?? 以? ?? />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>二쇱슂怨좉컼痢?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="mainCustomer" className={styles.input} value={formData.mainCustomer || ''} onChange={handleChange} />
                                        </div>
                                        <div className={styles.fieldLabel}>?쇳겕???/div>
                                        <div className={styles.fieldValue}>
                                            <input name="peakTime" className={styles.input} value={formData.peakTime || ''} onChange={handleChange} />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?뚯씠釉?猷?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="tableCount" className={styles.input} value={formData.tableCount || ''} onChange={handleChange} />
                                        </div>
                                        <div className={styles.fieldLabel}>異붿쿇?낆쥌</div>
                                        <div className={styles.fieldValue}>
                                            <input name="recommendedBusiness" className={styles.input} value={formData.recommendedBusiness || ''} onChange={handleChange} />
                                        </div>
                                    </div>
                                    {/* Custom Operation Fields */}
                                    {formData.operationCustomFields?.map((field: any, idx: number) => (
                                        <div className={styles.fieldRow} key={`op-${idx}`}>
                                            <div className={styles.fieldLabel}>{field.label}</div>
                                            <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                                <input
                                                    value={field.value}
                                                    className={styles.input}
                                                    onChange={(e) => handleCustomFieldChange('operation', idx, e.target.value)}
                                                />
                                            </div>
                                        </div>
                                    ))}
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>硫붾え</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <textarea name="operationMemo" className={styles.textarea} value={formData.operationMemo || ''} onChange={handleChange} placeholder="?곸뾽 愿??硫붾え瑜??낅젰?섏꽭?? />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>
                                            <button className={styles.smallBtn} onClick={() => setIsAddingOperationCategory(true)}><Plus size={12} /> 異붽?</button>
                                        </div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            {isAddingOperationCategory && (
                                                <div style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', gap: 6, width: '100%', flexWrap: 'nowrap' }}>
                                                    <input
                                                        className={styles.input}
                                                        placeholder="????ぉ ?대쫫"
                                                        value={newOperationCategory}
                                                        onChange={(e) => setNewOperationCategory(e.target.value)}
                                                        style={{ flex: 1, minWidth: 0 }}
                                                    />
                                                    <div style={{ display: 'flex', flexDirection: 'row', gap: 4, flexShrink: 0 }}>
                                                        <button className={styles.smallBtn} onClick={() => addCustomField('operation')} style={{ whiteSpace: 'nowrap' }}>?뺤씤</button>
                                                        <button className={styles.smallBtn} onClick={() => setIsAddingOperationCategory(false)} style={{ whiteSpace: 'nowrap' }}>痍⑥냼</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                        )}
                    </div>

                    {/* 6. ?꾨?李④?由?(Lease Management) */}
                    <div className={styles.sectionRow}>
                        <div
                            className={styles.verticalHeader}
                            style={{ backgroundColor: '#fab005', cursor: 'pointer' }}
                            onClick={() => toggleSection('lease')}
                        >??br />?<br />李?br />愿<br />由?/div>
                        {openSections.lease && (
                            <div className={styles.contentArea}>
                                <div className={styles.fieldGrid}>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?꾨?湲곌컙</div>
                                        <div className={styles.fieldValue}>
                                            <input name="leasePeriod" className={styles.input} value={formData.leasePeriod || ''} onChange={handleChange} placeholder="?? 2?? />
                                        </div>
                                        <div className={styles.fieldLabel}>?꾨?猷뚮???/div>
                                        <div className={styles.fieldValue}>
                                            <input name="rentFluctuation" className={styles.input} value={formData.rentFluctuation || ''} onChange={handleChange} placeholder="?? 5% ?몄긽" />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>怨듬??쒕쪟 ?섏옄</div>
                                        <div className={styles.fieldValue}>
                                            <input name="docDefects" className={styles.input} value={formData.docDefects || ''} onChange={handleChange} placeholder="?놁쓬" />
                                        </div>
                                        <div className={styles.fieldLabel}>?묒닔?꾪넻蹂?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="transferNotice" className={styles.input} value={formData.transferNotice || ''} onChange={handleChange} placeholder="?꾨즺" />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?뷀빐議곗꽌</div>
                                        <div className={styles.fieldValue}>
                                            <input name="settlementDefects" className={styles.input} value={formData.settlementDefects || ''} onChange={handleChange} placeholder="?놁쓬" />
                                        </div>
                                        <div className={styles.fieldLabel}>?꾨??몄젙蹂?/div>
                                        <div className={styles.fieldValue}>
                                            <input name="lessorInfo" className={styles.input} value={formData.lessorInfo || ''} onChange={handleChange} placeholder="?깊뼢 ?? />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?숈뾽/沅뚮━</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input name="partnershipRights" className={styles.input} value={formData.partnershipRights || ''} onChange={handleChange} placeholder="?뱀씠?ы빆 ?놁쓬" />
                                        </div>
                                    </div>
                                    {/* Custom Lease Fields */}
                                    {formData.leaseCustomFields?.map((field: any, idx: number) => (
                                        <div className={styles.fieldRow} key={`ls-${idx}`}>
                                            <div className={styles.fieldLabel}>{field.label}</div>
                                            <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                                <input
                                                    value={field.value}
                                                    className={styles.input}
                                                    onChange={(e) => handleCustomFieldChange('lease', idx, e.target.value)}
                                                />
                                            </div>
                                        </div>
                                    ))}
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>硫붾え</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <textarea name="leaseMemo" className={styles.textarea} value={formData.leaseMemo || ''} onChange={handleChange} placeholder="?꾨?李?愿??硫붾え瑜??낅젰?섏꽭?? />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>
                                            <button className={styles.smallBtn} onClick={() => setIsAddingLeaseCategory(true)}><Plus size={12} /> 異붽?</button>
                                        </div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            {isAddingLeaseCategory && (
                                                <div style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', gap: 6, width: '100%', flexWrap: 'nowrap' }}>
                                                    <input
                                                        className={styles.input}
                                                        placeholder="????ぉ ?대쫫"
                                                        value={newLeaseCategory}
                                                        onChange={(e) => setNewLeaseCategory(e.target.value)}
                                                        style={{ flex: 1, minWidth: 0 }}
                                                    />
                                                    <div style={{ display: 'flex', flexDirection: 'row', gap: 4, flexShrink: 0 }}>
                                                        <button className={styles.smallBtn} onClick={() => addCustomField('lease')} style={{ whiteSpace: 'nowrap' }}>?뺤씤</button>
                                                        <button className={styles.smallBtn} onClick={() => setIsAddingLeaseCategory(false)} style={{ whiteSpace: 'nowrap' }}>痍⑥냼</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* Right Side: Tabs */}
                <div className={styles.rightPanel}>
                    <div className={styles.tabs}>
                        {['priceWork', 'revenue', 'photos', 'contracts', 'reports', 'transfer', 'docs'].map(tab => (
                            <button
                                key={tab}
                                className={`${styles.tabBtn} ${activeTab === tab ? styles.activeTab : ''}`}
                                onClick={() => setActiveTab(tab)}
                            >
                                {tab === 'priceWork' && '湲덉븸?묒뾽'}
                                {tab === 'revenue' && '留ㅼ텧'}
                                {tab === 'photos' && '?ъ쭊吏??}
                                {tab === 'contracts' && '怨좉컼怨꾩빟'}
                                {tab === 'reports' && '由ы룷??}
                                {tab === 'transfer' && '臾쇨굔?꾩넚'}
                                {tab === 'docs' && '愿?⑤Ц??}
                            </button>
                        ))}
                    </div>
                    <div className={styles.tabContent}>
                        {activeTab === 'priceWork' && (
                            <div className={styles.tabPane}>
                                <div className={styles.paneHeader}>
                                    <h3>湲덉븸蹂?숇궡??/h3>
                                    <button className={styles.smallBtn} onClick={handleAddPriceHistory}><Plus size={14} /> ?댁뿭異붽?</button>
                                </div>
                                <table className={styles.listTable}>
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>?좎쭨</th>
                                            <th>?묒뾽??/th>
                                            <th>蹂?숉썑湲덉븸</th>
                                            <th>?댁뿭</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {/* Initial Entry */}
                                        {/* Dynamic Entries */}
                                        {(formData.priceHistory && formData.priceHistory.length > 0 ? formData.priceHistory : [{
                                            id: 'initial',
                                            date: formData.createdAt || new Date(),
                                            manager: formData.managerName,
                                            amount: formData.totalPrice,
                                            details: '理쒖큹?낅젰 湲덉븸?⑷퀎 (?먮룞???'
                                        }]).map((item: any, index: number) => (
                                            <tr key={item.id || index} onClick={() => item.id !== 'initial' && handleEditPriceHistory(item)} style={{ cursor: item.id !== 'initial' ? 'pointer' : 'default', ':hover': { backgroundColor: '#f8f9fa' } } as any}>
                                                <td>{index + 1}</td>
                                                <td>{formatDate(item.date)}</td>
                                                <td>{item.manager}</td>
                                                <td style={{ color: '#c92a2a', fontWeight: 'bold' }}>{formatCurrency(item.amount)}</td>
                                                <td>
                                                    {item.isImportant && <span style={{ color: 'red', marginRight: 4 }}>[以묒슂]</span>}
                                                    {item.details ? (item.details.length > 20 ? item.details.substring(0, 20) + '...' : item.details) : '-'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>

                                <div className={styles.paneHeader} style={{ marginTop: 24 }}>
                                    <h3>臾쇨굔?묒뾽?댁뿭</h3>
                                    <button className={styles.smallBtn} onClick={handleAddWorkHistory}><Plus size={14} /> ?묒뾽異붽?</button>
                                </div>
                                <table className={styles.listTable}>
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>?좎쭨</th>
                                            <th>?묒뾽??/th>
                                            <th>?댁뿭</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(!formData.workHistory || formData.workHistory.length === 0) ? (
                                            <tr>
                                                <td colSpan={4} style={{ textAlign: 'center', padding: 20, color: '#868e96' }}>?깅줉???묒뾽 ?댁뿭???놁뒿?덈떎.</td>
                                            </tr>
                                        ) : (
                                            formData.workHistory.map((item: any, index: number) => (
                                                <tr key={item.id || index} onClick={() => handleEditWorkHistory(item)} style={{ cursor: 'pointer', ':hover': { backgroundColor: '#f8f9fa' } } as any}>
                                                    <td>{index + 1}</td>
                                                    <td>{formatDate(item.date)}</td>
                                                    <td>{item.manager}</td>
                                                    <td>
                                                        [{item.targetType === 'customer' ? '怨좉컼' : '留ㅻЪ'}] {item.content}
                                                        {item.details && <div style={{ fontSize: 11, color: '#868e96' }}>{item.details.length > 30 ? item.details.substring(0, 30) + '...' : item.details}</div>}
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        {activeTab === 'revenue' && (
                            <div className={styles.tabPane}>
                                <div className={styles.paneHeader}>
                                    <h3>?붾퀎留ㅼ텧?꾪솴</h3>
                                    <div style={{ display: 'flex', gap: 6 }}>
                                        <button className={styles.smallBtn} onClick={handleDownloadTemplate} style={{ backgroundColor: '#107c41', color: 'white' }}><FileText size={14} /> ?묒떇</button>
                                        <button className={styles.smallBtn} onClick={() => fileInputRef.current?.click()} style={{ backgroundColor: '#217346', color: 'white' }}><FileText size={14} /> ?낅줈??/button>
                                        <input type="file" ref={fileInputRef} onChange={handleExcelUpload} style={{ display: 'none' }} accept=".xlsx, .xls" />
                                        <div style={{ width: 1, height: 20, backgroundColor: '#ddd', margin: '0 4px' }}></div>
                                        <button className={styles.smallBtn} onClick={handleAddRevenue}><Plus size={14} /> 留ㅼ텧異붽?</button>
                                        <button className={styles.smallBtn} onClick={handleDeleteRevenue} style={{ backgroundColor: '#fa5252', color: 'white' }}><Trash2 size={14} /> 留ㅼ텧??젣</button>
                                    </div>
                                </div>

                                <div style={{ height: '300px', overflowY: 'scroll', marginBottom: 20 }}>
                                    <table className={styles.listTable}>
                                        <thead>
                                            <tr>
                                                <th style={{ width: 40 }}><input type="checkbox" onChange={(e) => {
                                                    if (e.target.checked) setSelectedRevenueIds(formData.revenueHistory?.map((i: any) => i.id) || []);
                                                    else setSelectedRevenueIds([]);
                                                }} checked={selectedRevenueIds.length > 0 && selectedRevenueIds.length === (formData.revenueHistory?.length || 0)} /></th>
                                                <th>?좎쭨</th>
                                                <th>?꾧툑留ㅼ텧</th>
                                                <th>%</th>
                                                <th>移대뱶留ㅼ텧</th>
                                                <th>%</th>
                                                <th>?⑷퀎</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(!formData.revenueHistory || formData.revenueHistory.length === 0) ? (
                                                <tr><td colSpan={7} style={{ textAlign: 'center', padding: 20 }}>?깅줉??留ㅼ텧 ?곗씠?곌? ?놁뒿?덈떎.</td></tr>
                                            ) : (
                                                formData.revenueHistory.map((item: any) => {
                                                    const cashPct = item.total > 0 ? Math.round((item.cash / item.total) * 100) : 0;
                                                    const cardPct = item.total > 0 ? Math.round((item.card / item.total) * 100) : 0;
                                                    return (
                                                        <tr key={item.id} onClick={() => handleEditRevenue(item)} style={{ cursor: 'pointer', ':hover': { backgroundColor: '#f8f9fa' } } as any}>
                                                            <td onClick={(e) => e.stopPropagation()}>
                                                                <input type="checkbox" checked={selectedRevenueIds.includes(item.id)} onChange={(e) => {
                                                                    if (e.target.checked) setSelectedRevenueIds([...selectedRevenueIds, item.id]);
                                                                    else setSelectedRevenueIds(selectedRevenueIds.filter(id => id !== item.id));
                                                                }} />
                                                            </td>
                                                            <td>{item.date.substring(2)}</td>
                                                            <td style={{ color: '#1c7ed6' }}>{formatCurrency(item.cash)} 留뚯썝</td>
                                                            <td style={{ color: '#1c7ed6' }}>{cashPct}%</td>
                                                            <td style={{ color: '#37b24d' }}>{formatCurrency(item.card)} 留뚯썝</td>
                                                            <td style={{ color: '#37b24d' }}>{cardPct}%</td>
                                                            <td style={{ fontWeight: 'bold' }}>{formatCurrency(item.total)} 留뚯썝</td>
                                                        </tr>
                                                    );
                                                })
                                            )}
                                        </tbody>
                                        {formData.revenueHistory && formData.revenueHistory.length > 0 && (
                                            <tfoot>
                                                <tr style={{ backgroundColor: '#f8f9fa', fontWeight: 'bold' }}>
                                                    <td colSpan={2}>珥앺빀怨?/td>
                                                    <td>{formatCurrency(formData.revenueHistory.reduce((acc: number, curr: any) => acc + (curr.cash || 0), 0))} 留뚯썝</td>
                                                    <td></td>
                                                    <td>{formatCurrency(formData.revenueHistory.reduce((acc: number, curr: any) => acc + (curr.card || 0), 0))} 留뚯썝</td>
                                                    <td></td>
                                                    <td>{formatCurrency(formData.revenueHistory.reduce((acc: number, curr: any) => acc + (curr.total || 0), 0))} 留뚯썝</td>
                                                </tr>
                                            </tfoot>
                                        )}
                                    </table>
                                </div>

                                <div className={styles.paneHeader}>
                                    <h3>?붾퀎留ㅼ텧洹몃옒??/h3>
                                </div>
                                <div style={{ width: '100%', height: 300 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={[...(formData.revenueHistory || [])].reverse()}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis dataKey="date" />
                                            <YAxis yAxisId="left" />
                                            <YAxis yAxisId="right" orientation="right" />
                                            <Tooltip formatter={(value: number) => `${value.toLocaleString()} 留뚯썝`} />
                                            <Legend />
                                            <Bar yAxisId="left" dataKey="cash" name="?꾧툑" fill="#1c7ed6" stackId="a" />
                                            <Bar yAxisId="left" dataKey="card" name="移대뱶" fill="#37b24d" stackId="a" />
                                            <Line yAxisId="right" type="monotone" dataKey="total" name="?⑷퀎" stroke="#fab005" strokeWidth={2} />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}

                        {activeTab === 'photos' && (
                            <div className={styles.tabPane}>
                                <div className={styles.photoContainer}>
                                    <div className={styles.photoSectionHeader}>
                                        <span>臾쇨굔?ъ쭊</span>
                                        <div className={styles.headerActions}>
                                            <button className={styles.actionBtn} onClick={() => photoInputRef.current?.click()}>
                                                <Plus size={14} /> ?ъ쭊異붽?
                                            </button>
                                            <input
                                                type="file"
                                                ref={photoInputRef}
                                                onChange={handlePhotoUpload}
                                                style={{ display: 'none' }}
                                                accept="image/*"
                                                multiple
                                            />
                                            <button className={styles.actionBtn} style={{ borderColor: '#66d9e8', color: '#fff', backgroundColor: '#1098ad' }} onClick={handleDownloadAllPhotos}>
                                                <Download size={14} /> ?꾩껜?ㅼ슫濡쒕뱶
                                            </button>
                                            <button className={styles.actionBtn} style={{ borderColor: '#ff8787', color: '#fff', backgroundColor: '#fa5252' }} onClick={handleDeleteAllPhotos}>
                                                <Trash2 size={14} /> ?ъ쭊紐⑤몢??젣
                                            </button>
                                        </div>
                                    </div>

                                    <div className={styles.photoGrid}>
                                        {Array.from({ length: Math.max(12, (formData.photos?.length || 0)) }).map((_, index) => {
                                            const photo = formData.photos?.[index];
                                            return (
                                                <div
                                                    key={index}
                                                    className={styles.photoItem}
                                                    onClick={() => photo ? setPreviewImage(photo) : photoInputRef.current?.click()}
                                                >
                                                    {photo ? (
                                                        <>
                                                            <img src={photo} alt={`Property ${index}`} />
                                                            <div className={styles.photoActions}>
                                                                <button
                                                                    className={styles.downloadPhoto}
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        handleDownloadPhoto(photo, index);
                                                                    }}
                                                                >
                                                                    <Download size={12} />
                                                                </button>
                                                                <button
                                                                    className={styles.deletePhoto}
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        handleDeletePhoto(index);
                                                                    }}
                                                                >
                                                                    <X size={12} />
                                                                </button>
                                                            </div>
                                                        </>
                                                    ) : (
                                                        <span className={styles.photoPlaceholder}>PHOTO</span>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div style={{ marginTop: 20, borderTop: '1px solid #dee2e6', paddingTop: 20 }}>
                                    {formData.coordinates ? (
                                        <div style={{ width: '100%', height: '400px', position: 'relative', borderRadius: '4px', overflow: 'hidden', border: '1px solid #dee2e6' }}>
                                            {/* Overlay Header */}
                                            <div style={{ position: 'absolute', top: 10, left: 10, zIndex: 10, backgroundColor: 'rgba(255,255,255,0.9)', padding: '4px 8px', borderRadius: '4px', boxShadow: '0 1px 2px rgba(0,0,0,0.1)' }}>
                                                <h4 style={{ margin: 0, fontSize: '14px', fontWeight: 600, color: '#333' }}>?꾩튂 諛?吏??/h4>
                                            </div>
                                            <div style={{ position: 'absolute', top: 10, right: 10, zIndex: 10 }}>
                                                <div className={styles.toggleGroup}>
                                                    <button
                                                        className={`${styles.mapBtn} ${activeMapOverlay === 'skyview' ? styles.active : ''}`}
                                                        onClick={() => setActiveMapOverlay(activeMapOverlay === 'skyview' ? null : 'skyview')}
                                                    >
                                                        吏???ㅼ뭅?대럭
                                                    </button>
                                                    <button
                                                        className={`${styles.mapBtn} ${activeMapOverlay === 'use_district' ? styles.active : ''}`}
                                                        onClick={() => setActiveMapOverlay(activeMapOverlay === 'use_district' ? null : 'use_district')}
                                                    >
                                                        吏?곹렪吏묐룄
                                                    </button>
                                                </div>
                                            </div>

                                            <Map
                                                center={{ lat: formData.coordinates.lat, lng: formData.coordinates.lng }}
                                                style={{ width: "100%", height: "100%" }}
                                                level={3}
                                            >
                                                <MapMarker position={{ lat: formData.coordinates.lat, lng: formData.coordinates.lng }} />
                                                {activeMapOverlay === 'skyview' && mapConstants && <MapTypeId type={mapConstants.HYBRID} />}
                                                {activeMapOverlay === 'use_district' && mapConstants && <MapTypeId type={mapConstants.USE_DISTRICT} />}
                                            </Map>
                                        </div>
                                    ) : (
                                        <div style={{ width: '100%', height: '200px', backgroundColor: '#f1f3f5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#868e96', borderRadius: '4px' }}>
                                            醫뚰몴 ?뺣낫媛 ?놁뒿?덈떎. 二쇱냼瑜?寃?됲빐二쇱꽭??
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {activeTab === 'contracts' && (
                            <div className={styles.tabPane}>
                                {/* Promoted Customers Section */}
                                <div className={styles.paneHeader}>
                                    <h3>異붿쭊怨좉컼</h3>
                                    <div style={{ display: 'flex', gap: 6 }}>
                                        <button className={styles.smallBtn} onClick={() => { setPersonSelectorMode('promotedCustomer'); setInitialPersonTab('customer'); setIsPersonSelectorOpen(true); }}><Plus size={14} /> 怨좉컼異붽?</button>
                                        <button className={styles.smallBtn} onClick={() => { setPersonSelectorMode('promotedCustomer'); setInitialPersonTab('businessCard'); setIsPersonSelectorOpen(true); }}><Plus size={14} /> 紐낇븿異붽?</button>
                                    </div>
                                </div>
                                <div style={{ marginBottom: 20 }}>
                                    <table className={styles.listTable}>
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>?좎쭨</th>
                                                <th>?대쫫</th>
                                                <th>遺꾨쪟</th>
                                                <th>?덉궛</th>
                                                <th>?뱀쭠</th>
                                                <th>愿由?/th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(!formData.promotedCustomers || formData.promotedCustomers.length === 0) ? (
                                                <tr><td colSpan={7} style={{ textAlign: 'center', padding: 20 }}>?깅줉??異붿쭊 怨좉컼???놁뒿?덈떎.</td></tr>
                                            ) : (
                                                formData.promotedCustomers.map((customer: any, index: number) => (
                                                    <tr key={customer.id || index}>
                                                        <td>{index + 1}</td>
                                                        <td>{formatDate(customer.date)}</td>
                                                        <td>
                                                            <span style={{
                                                                backgroundColor: customer.type === 'customer' ? '#e64980' : '#7950f2',
                                                                color: 'white',
                                                                padding: '2px 6px',
                                                                borderRadius: 4,
                                                                fontSize: 11,
                                                                marginRight: 6
                                                            }}>
                                                                {customer.type === 'customer' ? '怨좉컼' : '紐낇븿'}
                                                            </span>
                                                            {customer.name}
                                                        </td>
                                                        <td>
                                                            <span style={{
                                                                backgroundColor: customer.classification === 'progress' ? '#339af0' :
                                                                    customer.classification === 'manage' ? '#fab005' :
                                                                        customer.classification === 'contract' ? '#51cf66' :
                                                                            customer.classification === 'hold' ? '#ff6b6b' : '#868e96',
                                                                color: 'white',
                                                                padding: '2px 8px',
                                                                borderRadius: 4,
                                                                fontSize: 11
                                                            }}>
                                                                {customer.classification === 'progress' ? '異붿쭊' :
                                                                    customer.classification === 'manage' ? '愿由? :
                                                                        customer.classification === 'contract' ? '怨꾩빟' :
                                                                            customer.classification === 'hold' ? '蹂대쪟' :
                                                                                customer.classification === 'complete' ? '?꾨즺' :
                                                                                    customer.classification || '-'}
                                                            </span>
                                                        </td>
                                                        <td>{(customer.budget && !isNaN(Number(customer.budget))) ? formatCurrency(customer.budget) : '-'}</td>
                                                        <td>{customer.features}</td>
                                                        <td>
                                                            <button className={styles.deletePhoto} onClick={() => handleRemovePromotedCustomer(index)}>
                                                                <Trash2 size={12} />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Contract History Section */}
                                <div className={styles.paneHeader} style={{ marginTop: 20, borderTop: '1px solid #dee2e6', paddingTop: 20 }}>
                                    <h3>怨꾩빟?덉뒪?좊━</h3>
                                    <div style={{ display: 'flex', gap: 6 }}>
                                        <button className={styles.smallBtn} onClick={handleAddContract}><Plus size={14} /> 怨꾩빟異붽?</button>
                                    </div>
                                </div>
                                <div>
                                    <table className={styles.listTable}>
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>怨꾩빟??/th>
                                                <th>醫낅쪟</th>
                                                <th>留ㅻℓ媛</th>
                                                <th>蹂댁쬆湲?/th>
                                                <th>?꾨?猷?/th>
                                                <th>怨꾩빟??/th>
                                                <th>?꾪솕踰덊샇</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(!formData.contractHistory || formData.contractHistory.length === 0) ? (
                                                <tr><td colSpan={8} style={{ textAlign: 'center', padding: 20 }}>?깅줉??怨꾩빟 ?댁뿭???놁뒿?덈떎.</td></tr>
                                            ) : (
                                                formData.contractHistory.map((contract: any, index: number) => (
                                                    <tr key={contract.id || index} onClick={() => handleEditContract(contract)} style={{ cursor: 'pointer', ':hover': { backgroundColor: '#f8f9fa' } } as any}>
                                                        <td>{index + 1}</td>
                                                        <td>{contract.contractDate}</td>
                                                        <td>
                                                            <span style={{
                                                                backgroundColor: contract.type === '留ㅻℓ' ? '#339af0' : contract.type === '?꾩꽭' ? '#51cf66' : contract.type === '?붿꽭' ? '#ff6b6b' : '#cc5de8',
                                                                color: 'white',
                                                                padding: '2px 6px',
                                                                borderRadius: 4,
                                                                fontSize: 11
                                                            }}>
                                                                {contract.type}
                                                            </span>
                                                        </td>
                                                        <td>{contract.type === '留ㅻℓ' ? formatCurrency(contract.deposit) : '-'}</td>
                                                        <td>{contract.type !== '留ㅻℓ' ? formatCurrency(contract.deposit) : '-'}</td>
                                                        <td>{formatCurrency(contract.monthlyRent)}</td>
                                                        <td>{contract.contractorName}</td>
                                                        <td>{contract.contractorPhone}</td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {activeTab === 'docs' && (
                            <div className={styles.tabPane}>
                                <div className={styles.paneHeader} style={{ backgroundColor: '#339af0', color: 'white', padding: '10px 15px', borderRadius: '4px 4px 0 0', margin: '-15px -15px 15px -15px' }}>
                                    <h3 style={{ color: 'white', margin: 0, fontSize: 15 }}>臾쇨굔愿?⑤Ц??/h3>
                                    <div style={{ display: 'flex', gap: 6 }}>
                                        <button
                                            className={styles.smallBtn}
                                            onClick={() => docInputRef.current?.click()}
                                            style={{ backgroundColor: 'white', color: '#339af0', border: 'none', fontWeight: 'bold' }}
                                        >
                                            <Plus size={14} /> 臾몄꽌異붽?
                                        </button>
                                        <input type="file" ref={docInputRef} onChange={handleDocUpload} style={{ display: 'none' }} multiple />
                                        <button
                                            className={styles.smallBtn}
                                            onClick={handleDeleteDocuments}
                                            style={{ backgroundColor: '#ffa8a5', color: '#c92a2a', border: '1px solid #ff8787', fontWeight: 'bold' }}
                                        >
                                            <Trash2 size={14} /> 臾몄꽌??젣
                                        </button>
                                    </div>
                                </div>
                                <div style={{ height: '500px', overflowY: 'auto' }}>
                                    <table className={styles.listTable}>
                                        <thead>
                                            <tr>
                                                <th style={{ width: 40, textAlign: 'center' }}>
                                                    <input
                                                        type="checkbox"
                                                        onChange={(e) => {
                                                            if (e.target.checked) setSelectedDocIds(formData.documents?.map((d: any) => d.id) || []);
                                                            else setSelectedDocIds([]);
                                                        }}
                                                        checked={formData.documents?.length > 0 && selectedDocIds.length === formData.documents.length}
                                                    />
                                                </th>
                                                <th style={{ width: 50, textAlign: 'center' }}>No</th>
                                                <th style={{ width: 120, textAlign: 'center' }}>?좎쭨</th>
                                                <th style={{ width: 100, textAlign: 'center' }}>泥⑤???/th>
                                                <th style={{ width: 80, textAlign: 'center' }}>醫낅쪟</th>
                                                <th>臾몄꽌紐?/th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(!formData.documents || formData.documents.length === 0) ? (
                                                <tr><td colSpan={6} style={{ textAlign: 'center', padding: 50, color: '#868e96' }}>?깅줉??愿??臾몄꽌媛 ?놁뒿?덈떎.</td></tr>
                                            ) : (
                                                formData.documents.map((doc: any, index: number) => (
                                                    <tr key={doc.id || index}>
                                                        <td style={{ textAlign: 'center' }}>
                                                            <input
                                                                type="checkbox"
                                                                checked={selectedDocIds.includes(doc.id)}
                                                                onChange={(e) => {
                                                                    if (e.target.checked) setSelectedDocIds([...selectedDocIds, doc.id]);
                                                                    else setSelectedDocIds(selectedDocIds.filter(id => id !== doc.id));
                                                                }}
                                                            />
                                                        </td>
                                                        <td style={{ textAlign: 'center' }}>{formData.documents.length - index}</td>
                                                        <td style={{ textAlign: 'center', color: '#1c7ed6' }}>{doc.date} <span style={{ color: '#868e96', fontSize: 11 }}>({new Date(doc.date).toLocaleDateString('ko-KR', { weekday: 'short' })})</span></td>
                                                        <td style={{ textAlign: 'center', color: '#1098ad' }}>{doc.uploader}</td>
                                                        <td style={{ textAlign: 'center' }}>{getDocIcon(doc.type)}</td>
                                                        <td style={{ fontWeight: '500' }}>
                                                            {doc.url ? (
                                                                <a
                                                                    href={doc.url}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    style={{ color: 'inherit', textDecoration: 'none', ':hover': { textDecoration: 'underline', color: '#339af0' } } as any}
                                                                >
                                                                    {doc.name}
                                                                </a>
                                                            ) : (
                                                                doc.name
                                                            )}
                                                            <span style={{ fontSize: 11, color: '#adb5bd', marginLeft: 6 }}>
                                                                ({(doc.size / 1024 / 1024).toFixed(2)} MB)
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'reports' && (
                            <div className={styles.tabPane} style={{ padding: 0, height: '100%', overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
                                <PropertyReportTab
                                    data={formData}
                                    onChange={(field, value) => handleChange({ target: { name: field, value } } as any)}
                                    onSave={() => autoSaveProperty(formData)}
                                    initialDirectPreview={directReportPreview}
                                />
                            </div>
                        )}

                        {activeTab !== 'priceWork' && activeTab !== 'revenue' && activeTab !== 'photos' && activeTab !== 'contracts' && activeTab !== 'docs' && activeTab !== 'transfer' && activeTab !== 'reports' && (
                            <div style={{ padding: 20, textAlign: 'center', color: '#868e96' }}>
                                以鍮?以묒씤 湲곕뒫?낅땲??
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Footer Actions */}
            <div className={styles.footer}>
                <div className={styles.footerLeft}>
                    <button className={styles.footerBtn} onClick={handleSave} disabled={isLoading}>
                        <Save size={14} /> ???                    </button>
                    <button className={styles.footerBtn} onClick={handleDelete} disabled={isLoading}>
                        <Trash2 size={14} /> ??젣
                    </button>
                </div>
                <div className={styles.footerRight}>
                    <button className={styles.footerBtn} onClick={handleNew}><Plus size={14} /> ?좉퇋</button>
                    <button className={styles.footerBtn} onClick={handleCopy} disabled={isLoading}><Copy size={14} /> 蹂듭궗</button>
                    <button className={styles.footerBtn} onClick={() => {
                        // Check if favorite exists to provide guidance if not
                        const userStr = typeof window !== 'undefined' ? localStorage.getItem('user') : null;
                        let userId = 'default';
                        if (userStr) {
                            try {
                                const u = JSON.parse(userStr);
                                userId = (u.user || u).id || (u.user || u).userId || (u.user || u).name || 'default';
                            } catch (e) { }
                        }
                        const favId = localStorage.getItem(`favorite_report_format_${userId}`);

                        if (!favId) {
                            showToast('?몄뇙?뺤떇??利먭꺼李얘린(蹂??꾩씠肄? ?대몢?쒕㈃ ?ㅼ쓬遺?곕뒗 ?대떦 ?묒떇?쇰줈 諛붾줈 ?몄뇙 誘몃━蹂닿린媛 ?대┰?덈떎.');
                        }

                        setActiveTab('reports');
                        setDirectReportPreview(Date.now());
                    }}><Printer size={14} /> ?몄뇙</button>
                    <button className={styles.footerBtn} onClick={onClose}>?リ린</button>
                </div>
            </div>

            {/* Address Search Modal */}
            {
                isSearchOpen && (
                    <div className={styles.searchModal}>
                        <div className={styles.modalContent}>
                            <div className={styles.modalHeader}>
                                <h3>二쇱냼 寃??/h3>
                                <button type="button" onClick={() => setIsSearchOpen(false)}><X size={20} /></button>
                            </div>
                            <DaumPostcodeEmbed onComplete={handleComplete} autoClose={false} />
                        </div>
                    </div>
                )
            }

            {/* Brand Search Modal */}
            {
                isBrandSearchOpen && (
                    <div className={styles.searchModal}>
                        <div className={styles.modalContent}>
                            <div className={styles.modalHeader}>
                                <h3>?꾨옖李⑥씠利?釉뚮옖??寃??/h3>
                                <button type="button" onClick={() => setIsBrandSearchOpen(false)}><X size={20} /></button>
                            </div>
                            <div style={{ padding: '20px' }}>
                                <div className={styles.searchBox} style={{ alignItems: 'center' }}>
                                    <input
                                        type="text"
                                        placeholder="釉뚮옖?쒕챸 ?낅젰"
                                        className={styles.input}
                                        value={brandSearchQuery}
                                        onChange={(e) => setBrandSearchQuery(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                searchBrands();
                                            }
                                        }}
                                        style={{ flex: 1, minWidth: 0 }}
                                    />
                                    <button type="button" className={styles.smallBtn} onClick={searchBrands} disabled={isSearchingBrand} style={{ whiteSpace: 'nowrap', flexShrink: 0 }}>
                                        {isSearchingBrand ? '寃??以?..' : '寃??}
                                    </button>
                                </div>
                                <div style={{ marginTop: '20px', maxHeight: '300px', overflowY: 'auto' }}>
                                    {brandSearchResults.length > 0 ? (
                                        brandSearchResults.map((brand, index) => (
                                            <div
                                                key={index}
                                                style={{ padding: '10px', borderBottom: '1px solid #eee', cursor: 'pointer' }}
                                                onClick={() => handleBrandSelect(brand)}
                                            >
                                                <div style={{ fontWeight: 'bold' }}>{brand.brandNm}</div>
                                                <div style={{ fontSize: '12px', color: '#868e96' }}>
                                                    {brand.indutyLclasNm} {'>'} {brand.indutyMlsfcNm}
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        <p style={{ fontSize: '13px', color: '#868e96', textAlign: 'center' }}>
                                            {isSearchingBrand ? '寃??以묒엯?덈떎...' : '寃??寃곌낵媛 ?놁뒿?덈떎.'}
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
            {/* Price History Modal */}
            {
                isPriceHistoryOpen && (
                    <div className={styles.searchModal}>
                        <div className={styles.modalContent} style={{ width: '800px', maxWidth: '95vw' }}>
                            <div className={styles.modalHeader}>
                                <h3>{editingHistoryId ? '湲덉븸?묒뾽?댁뿭 ?섏젙' : '湲덉븸?묒뾽?댁뿭 異붽?'}</h3>
                                <button type="button" onClick={() => setIsPriceHistoryOpen(false)}><X size={20} /></button>
                            </div>
                            <div style={{ padding: '20px' }}>
                                <div className={styles.fieldGrid}>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>蹂?숉썑湲덉븸</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="text"
                                                className={styles.input}
                                                style={{ width: '150px' }}
                                                value={priceHistoryForm.amount}
                                                onChange={(e) => setPriceHistoryForm(prev => ({ ...prev, amount: Number(e.target.value.replace(/,/g, '')) }))}
                                            />
                                            <span style={{ fontSize: 12, marginLeft: 4 }}>留?/span>
                                            <label style={{ marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: 4, fontSize: 13 }}>
                                                <input
                                                    type="checkbox"
                                                    checked={priceHistoryForm.isImportant}
                                                    onChange={(e) => setPriceHistoryForm(prev => ({ ...prev, isImportant: e.target.checked }))}
                                                />
                                                以묒슂泥댄겕
                                            </label>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?좎쭨</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="date"
                                                className={styles.input}
                                                style={{ width: '150px' }}
                                                value={priceHistoryForm.date}
                                                onChange={(e) => setPriceHistoryForm(prev => ({ ...prev, date: e.target.value }))}
                                            />
                                            <div style={{ display: 'flex', gap: 6, marginLeft: 8 }}>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => adjustDate(-1, 'price')}>-1??/button>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => setDateTo('yesterday', 'price')}>?댁젣</button>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => setDateTo('today', 'price')}>?ㅻ뒛</button>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => setDateTo('tomorrow', 'price')}>?댁씪</button>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => adjustDate(1, 'price')}>+1??/button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?곸꽭?댁뿭</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3', height: '100px' }}>
                                            <textarea
                                                className={styles.textarea}
                                                value={priceHistoryForm.details}
                                                onChange={(e) => setPriceHistoryForm(prev => ({ ...prev, details: e.target.value }))}
                                                style={{ height: '100%' }}
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div style={{ marginTop: 20, display: 'flex', justifyContent: 'flex-end', gap: 8 }}>
                                    {editingHistoryId && (
                                        <button className={styles.footerBtn} style={{ backgroundColor: '#fa5252', color: 'white', marginRight: 'auto' }} onClick={handleDeletePriceHistory}>
                                            <Trash2 size={14} /> ??젣
                                        </button>
                                    )}
                                    <button className={styles.footerBtn} style={{ backgroundColor: '#339af0', color: 'white' }} onClick={handleSavePriceHistory}>
                                        <Save size={14} /> {editingHistoryId ? '?섏젙?ы빆 ??? : '?댁뿭??ν썑 ?リ린'}
                                    </button>
                                    <button className={styles.footerBtn} onClick={() => setIsPriceHistoryOpen(false)}>
                                        <X size={14} /> ?リ린
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }

            {/* Revenue Modal */}
            {
                isRevenueModalOpen && (
                    <div className={styles.searchModal}>
                        <div className={styles.modalContent} style={{ width: '400px' }}>
                            <div className={styles.modalHeader}>
                                <h3>{editingRevenueId ? '?붾ℓ異쒕궡???섏젙' : '?붾ℓ異쒕궡??異붽?'}</h3>
                                <button type="button" onClick={() => setIsRevenueModalOpen(false)}><X size={20} /></button>
                            </div>
                            <div style={{ padding: 20 }}>
                                <div style={{ display: 'flex', gap: 10, marginBottom: 15, alignItems: 'center' }}>
                                    <input className={styles.input} type="number" style={{ width: 80 }} value={revenueForm.year} onChange={(e) => setRevenueForm({ ...revenueForm, year: Number(e.target.value) })} />
                                    <span>??/span>
                                    <input className={styles.input} type="number" style={{ width: 60 }} value={revenueForm.month} onChange={(e) => setRevenueForm({ ...revenueForm, month: Number(e.target.value) })} />
                                    <span>??/span>
                                </div>
                                <div className={styles.fieldRow} style={{ marginBottom: 10 }}>
                                    <div className={styles.fieldLabel}>?꾧툑留ㅼ텧</div>
                                    <div className={styles.fieldValue}>
                                        <input className={styles.input} type="number" value={revenueForm.cash || ''} onChange={(e) => setRevenueForm({ ...revenueForm, cash: Number(e.target.value) })} placeholder="0" />
                                        <span style={{ fontSize: 12, marginLeft: 4 }}>留뚯썝</span>
                                    </div>
                                </div>
                                <div className={styles.fieldRow}>
                                    <div className={styles.fieldLabel}>移대뱶留ㅼ텧</div>
                                    <div className={styles.fieldValue}>
                                        <input className={styles.input} type="number" value={revenueForm.card || ''} onChange={(e) => setRevenueForm({ ...revenueForm, card: Number(e.target.value) })} placeholder="0" />
                                        <span style={{ fontSize: 12, marginLeft: 4 }}>留뚯썝</span>
                                    </div>
                                </div>
                                <div style={{ marginTop: 20, textAlign: 'right' }}>
                                    <button className={styles.primaryBtn} onClick={handleSaveRevenue}>{editingRevenueId ? '?섏젙?ы빆 ??? : '??ν썑 怨꾩냽?낅젰'}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }

            {/* Work History Modal */}
            {
                isWorkHistoryOpen && (
                    <div className={styles.searchModal}>
                        <div className={styles.modalContent} style={{ width: '800px', maxWidth: '95vw' }}>
                            <div className={styles.modalHeader}>
                                <h3>{editingHistoryId ? '?묒뾽?댁뿭 ?섏젙' : '?묒뾽?댁뿭 異붽?'}</h3>
                                <button type="button" onClick={() => setIsWorkHistoryOpen(false)}><X size={20} /></button>
                            </div>
                            <div style={{ padding: '20px' }}>
                                <div className={styles.fieldGrid}>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?댁뿭</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                className={styles.input}
                                                value={workHistoryForm.content}
                                                onChange={(e) => setWorkHistoryForm(prev => ({ ...prev, content: e.target.value }))}
                                            />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?좎쭨</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <input
                                                type="date"
                                                className={styles.input}
                                                style={{ width: '150px' }}
                                                value={workHistoryForm.date}
                                                onChange={(e) => setWorkHistoryForm(prev => ({ ...prev, date: e.target.value }))}
                                            />
                                            <div style={{ display: 'flex', gap: 6, marginLeft: 8 }}>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => adjustDate(-1, 'work')}>-1??/button>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => setDateTo('yesterday', 'work')}>?댁젣</button>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => setDateTo('today', 'work')}>?ㅻ뒛</button>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => setDateTo('tomorrow', 'work')}>?댁씪</button>
                                                <button className={styles.smallBtn} style={{ padding: '6px 12px', height: 'auto', whiteSpace: 'nowrap' }} onClick={() => adjustDate(1, 'work')}>+1??/button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>?곸꽭?댁뿭</div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3', height: '100px' }}>
                                            <textarea
                                                className={styles.textarea}
                                                value={workHistoryForm.details}
                                                onChange={(e) => setWorkHistoryForm(prev => ({ ...prev, details: e.target.value }))}
                                                style={{ height: '100%' }}
                                            />
                                        </div>
                                    </div>
                                    <div className={styles.fieldRow}>
                                        <div className={styles.fieldLabel}>???/div>
                                        <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                            <select
                                                className={styles.select}
                                                style={{ width: '80px', marginRight: 4 }}
                                                value={workHistoryForm.targetType}
                                                onChange={(e) => setWorkHistoryForm(prev => ({ ...prev, targetType: e.target.value }))}
                                            >
                                                <option value="customer">怨좉컼</option>
                                                <option value="businessCard">紐낇븿</option>
                                            </select>
                                            <input
                                                className={styles.input}
                                                value={workHistoryForm.targetKeyword}
                                                onChange={(e) => setWorkHistoryForm(prev => ({ ...prev, targetKeyword: e.target.value }))}
                                                style={{ backgroundColor: '#fff9db' }}
                                            />
                                            <button className={styles.smallBtn} style={{ marginLeft: 4 }} onClick={() => setIsPersonSelectorOpen(true)}><Plus size={12} /> 紐⑸줉?먯꽌 李얘린</button>
                                        </div>
                                    </div>
                                </div>
                                <div style={{ marginTop: 20, display: 'flex', justifyContent: 'flex-end', gap: 8 }}>
                                    {editingHistoryId && (
                                        <button className={styles.footerBtn} style={{ backgroundColor: '#fa5252', color: 'white', marginRight: 'auto' }} onClick={handleDeleteWorkHistory}>
                                            <Trash2 size={14} /> ??젣
                                        </button>
                                    )}
                                    <button className={styles.footerBtn} style={{ backgroundColor: '#339af0', color: 'white' }} onClick={handleSaveWorkHistory}>
                                        <Save size={14} /> {editingHistoryId ? '?섏젙?ы빆 ??? : '?댁뿭??ν썑 ?リ린'}
                                    </button>
                                    <button className={styles.footerBtn} onClick={() => setIsWorkHistoryOpen(false)}>
                                        <X size={14} /> ?リ린
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
            {/* Image Preview Modal */}
            {
                previewImage && (
                    <div className={styles.imageModalOverlay} onClick={() => setPreviewImage(null)}>
                        <div className={styles.imageModalContent} onClick={e => e.stopPropagation()}>
                            <button className={styles.closeImageModal} onClick={() => setPreviewImage(null)}>
                                <X size={24} />
                            </button>
                            <img src={previewImage} alt="Preview" />
                        </div>
                    </div>
                )
            }

            {/* Contract History Modal */}
            {isContractModalOpen && (
                <div className={styles.searchModal}>
                    <div className={styles.modalContent} style={{ width: '800px', maxWidth: '95vw' }}>
                        <div className={styles.modalHeader}>
                            <h3>{editingContractId ? '怨꾩빟?덉뒪?좊━ ?섏젙' : '怨꾩빟?덉뒪?좊━ 異붽?'}</h3>
                            <button type="button" onClick={() => setIsContractModalOpen(false)}><X size={20} /></button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div className={styles.fieldGrid}>
                                <div className={styles.fieldRow}>
                                    <div className={styles.fieldLabel}>怨꾩빟醫낅쪟</div>
                                    <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                        <div style={{ display: 'flex', gap: 12 }}>
                                            {['留ㅻℓ', '?꾩꽭', '?붿꽭', '?곗꽭'].map(type => (
                                                <label key={type} style={{ display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer' }}>
                                                    <input
                                                        type="radio"
                                                        name="contractType"
                                                        checked={contractForm.type === type}
                                                        onChange={() => setContractForm(prev => ({ ...prev, type }))}
                                                    />
                                                    <span style={{
                                                        backgroundColor: type === '留ㅻℓ' ? '#339af0' : type === '?꾩꽭' ? '#51cf66' : type === '?붿꽭' ? '#ff6b6b' : '#cc5de8',
                                                        color: 'white',
                                                        padding: '2px 8px',
                                                        borderRadius: 4,
                                                        fontSize: 12
                                                    }}>{type}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className={styles.fieldRow}>
                                    <div className={styles.fieldLabel}>怨꾩빟??/div>
                                    <div className={styles.fieldValue}>
                                        <input className={styles.input} value={contractForm.contractorName} onChange={(e) => setContractForm(prev => ({ ...prev, contractorName: e.target.value }))} />
                                    </div>
                                    <div className={styles.fieldLabel}>?곕씫泥?/div>
                                    <div className={styles.fieldValue}>
                                        <input className={styles.input} value={contractForm.contractorPhone} onChange={(e) => setContractForm(prev => ({ ...prev, contractorPhone: e.target.value }))} />
                                    </div>
                                </div>
                                <div className={styles.fieldRow}>
                                    <div className={styles.fieldLabel}>怨꾩빟??/div>
                                    <div className={styles.fieldValue}>
                                        <input type="date" className={styles.input} value={contractForm.contractDate} onChange={(e) => setContractForm(prev => ({ ...prev, contractDate: e.target.value }))} />
                                    </div>
                                    <div className={styles.fieldLabel}>留뚭린??/div>
                                    <div className={styles.fieldValue}>
                                        <input type="date" className={styles.input} value={contractForm.expirationDate} onChange={(e) => setContractForm(prev => ({ ...prev, expirationDate: e.target.value }))} />
                                    </div>
                                </div>
                                <div className={styles.fieldRow}>
                                    <div className={styles.fieldLabel}>蹂댁쬆湲?/div>
                                    <div className={styles.fieldValue}>
                                        <input className={styles.input} style={{ textAlign: 'right' }} value={formatInput(contractForm.deposit)} onChange={(e) => setContractForm(prev => ({ ...prev, deposit: Number(e.target.value.replace(/,/g, '')) }))} />
                                        <span style={{ fontSize: 12, marginLeft: 4 }}>留뚯썝</span>
                                    </div>
                                    <div className={styles.fieldLabel}>?꾨?猷?/div>
                                    <div className={styles.fieldValue}>
                                        <input className={styles.input} style={{ textAlign: 'right' }} value={formatInput(contractForm.monthlyRent)} onChange={(e) => setContractForm(prev => ({ ...prev, monthlyRent: Number(e.target.value.replace(/,/g, '')) }))} />
                                        <span style={{ fontSize: 12, marginLeft: 4 }}>留뚯썝</span>
                                    </div>
                                </div>
                                <div className={styles.fieldRow}>
                                    <div className={styles.fieldLabel}>沅뚮━湲?/div>
                                    <div className={styles.fieldValue} style={{ gridColumn: 'span 3' }}>
                                        <input className={styles.input} style={{ width: '150px', textAlign: 'right' }} value={formatInput(contractForm.premium)} onChange={(e) => setContractForm(prev => ({ ...prev, premium: Number(e.target.value.replace(/,/g, '')) }))} />
                                        <span style={{ fontSize: 12, marginLeft: 4 }}>留뚯썝</span>
                                    </div>
                                </div>
                                <div className={styles.fieldRow}>
                                    <div className={styles.fieldLabel}>怨꾩빟?뺣낫</div>
                                    <div className={styles.fieldValue} style={{ gridColumn: 'span 3', height: '120px' }}>
                                        <textarea className={styles.textarea} style={{ height: '100%' }} value={contractForm.details} onChange={(e) => setContractForm(prev => ({ ...prev, details: e.target.value }))} />
                                    </div>
                                </div>
                            </div>
                            <div style={{ marginTop: 20, display: 'flex', justifyContent: 'flex-end', gap: 8 }}>
                                {editingContractId && (
                                    <button className={styles.footerBtn} style={{ backgroundColor: '#fa5252', color: 'white', marginRight: 'auto' }} onClick={handleDeleteContract}>
                                        <Trash2 size={14} /> ??젣
                                    </button>
                                )}
                                <button className={styles.footerBtn} style={{ backgroundColor: '#339af0', color: 'white' }} onClick={handleSaveContract}>
                                    <Save size={14} /> {editingContractId ? '?섏젙?ы빆 ??? : '?댁뿭??ν썑 ?リ린'}
                                </button>
                                <button className={styles.footerBtn} onClick={() => setIsContractModalOpen(false)}>
                                    <X size={14} /> ?リ린
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}



            <PersonSelectorModal
                isOpen={isPersonSelectorOpen}
                onClose={() => setIsPersonSelectorOpen(false)}
                onSelect={handlePersonSelect}
                companyName={formData.companyName || ''}
                initialTab={personSelectorMode === 'promotedCustomer' ? initialPersonTab : (workHistoryForm.targetType === 'businessCard' ? 'businessCard' : 'customer')}
            />

            {/* Custom Toast */}
            {toast.visible && (
                <div className={styles.toastContainer}>
                    <div className={styles.toastContent}>
                        <Star size={16} fill="#fab005" color="#fab005" />
                        {toast.message}
                    </div>
                </div>
            )}
        </div >
    );
}
